<!DOCTYPE html>
<html lang="id" class="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POS Kasir - TemenBoss</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
          },
          colors: {
            primary: {
              50: '#eff6ff',
              100: '#dbeafe',
              200: '#bfdbfe',
              300: '#93c5fd',
              400: '#60a5fa',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8',
              800: '#1e40af',
              900: '#1e3a8a',
            }
          }
        }
      }
    }
  </script>
  
  <style>
    * { scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent; }
    *::-webkit-scrollbar { width: 6px; height: 6px; }
    *::-webkit-scrollbar-track { background: transparent; }
    *::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .dark *::-webkit-scrollbar-thumb { background: #475569; }
    
    .panel-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .product-card { transition: transform 0.2s, box-shadow 0.2s; }
    .product-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
    .product-card.sold-out { opacity: 0.5; pointer-events: none; }
    .cart-item { transition: background-color 0.2s; }
    .cart-item:hover { background-color: rgba(59, 130, 246, 0.05); }
    
    .btn-primary { @apply px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium transition-colors; }
    .btn-secondary { @apply px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg font-medium transition-colors; }
    .btn-danger { @apply px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors; }
    .input-field { @apply w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition-all; }
    .tab-btn { @apply px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 border-b-2 border-transparent transition-colors; }
    .tab-btn.active { @apply text-primary-600 dark:text-primary-400 border-primary-600; }
    
    [contenteditable]:empty:before { content: attr(placeholder); color: #9ca3af; cursor: text; }
    .variant-badge { @apply inline-flex items-center px-2 py-0.5 text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded; }
    .discount-badge { @apply inline-flex items-center px-1.5 py-0.5 text-xs font-bold bg-red-500 text-white rounded; }
    
    @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(1.3); opacity: 0; } }
    .pulse-indicator::after { content: ''; position: absolute; width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: pulse-ring 2s infinite; }
    
    .modal-overlay { @apply fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center; }
    .modal-content { @apply bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg mx-4; animation: fadeIn 0.2s ease-out; }
    .modal-large { @apply max-w-4xl; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    
    .grid-products { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
    @media (max-width: 1400px) { .grid-products { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 1200px) { .grid-products { grid-template-columns: repeat(2, 1fr); } }
    .list-view .grid-products { grid-template-columns: 1fr; }
    .hidden-feature { display: none !important; }
    
    .spinner { border: 3px solid #e2e8f0; border-top: 3px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Toast notification */
    .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
    .toast { padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500; animation: slideIn 0.3s ease-out; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .toast-success { background: #10b981; }
    .toast-error { background: #ef4444; }
    .toast-warning { background: #f59e0b; }
    .toast-info { background: #3b82f6; }

    /* Sound effect button */
    .btn-beep { position: relative; }
    .btn-beep::after { content: ''; position: absolute; inset: 0; pointer-events: none; }

    /* Queue number display */
    .queue-number { font-size: 2rem; font-weight: bold; color: #3b82f6; text-align: center; padding: 1rem; background: linear-gradient(135deg, #eff6ff, #dbeafe); border-radius: 1rem; margin-bottom: 1rem; }
    .dark .queue-number { background: linear-gradient(135deg, #1e3a8a, #1e40af); color: #bfdbfe; }

    /* Customer info card */
    .customer-info-card { background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-left: 4px solid #3b82f6; }
    .dark .customer-info-card { background: linear-gradient(135deg, #1e3a8a/20, #1e40af/20); }

    /* Transaction status badges */
    .status-pending { @apply bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300; }
    .status-completed { @apply bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300; }
    .status-cancelled { @apply bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans antialiased h-screen overflow-hidden">
  
  <!-- Toast Container -->
  <div id="toast-container" class="toast-container"></div>
  
  <!-- ==================== OPEN SESSION MODAL ==================== -->
  <div id="modal-open-session" class="modal-overlay">
    <div class="modal-content">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <h2 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-door-open text-primary-600"></i>Sesi Buka Kasir</h2>
        <p class="text-gray-500 dark:text-gray-400 mt-1">Masukkan modal awal untuk memulai sesi kasir</p>
      </div>
      <div class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">Modal Awal (Rp)</label>
          <input type="number" id="opening-amount" class="input-field text-2xl font-mono" placeholder="0" autofocus>
        </div>
        <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3">
          <p class="text-sm text-yellow-800 dark:text-yellow-200"><i class="fas fa-info-circle mr-1"></i>Pastikan jumlah uang di laci sesuai dengan modal awal yang dimasukkan.</p>
        </div>
      </div>
      <div class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
        <button onclick="POSApp.logout()" class="btn-secondary"><i class="fas fa-sign-out-alt mr-2"></i>Keluar</button>
        <button onclick="POSApp.openSession()" class="btn-primary"><i class="fas fa-play mr-2"></i>Mulai Sesi</button>
      </div>
    </div>
  </div>
  
  <!-- ==================== CLOSE SESSION MODAL ==================== -->
  <div id="modal-close-session" class="modal-overlay hidden">
    <div class="modal-content max-w-2xl">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <h2 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-door-closed text-red-600"></i>Sesi Tutup Kasir</h2>
        <p class="text-gray-500 dark:text-gray-400 mt-1">Masukkan modal akhir untuk menutup sesi kasir</p>
      </div>
      <div class="p-6 space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">Modal Awal</p>
            <p class="text-xl font-mono font-bold" id="summary-opening">Rp 0</p>
          </div>
          <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">Total Penjualan</p>
            <p class="text-xl font-mono font-bold text-green-600" id="summary-sales">Rp 0</p>
          </div>
          <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">Total Transaksi</p>
            <p class="text-xl font-mono font-bold" id="summary-transactions">0</p>
          </div>
          <div class="bg-primary-50 dark:bg-primary-900/20 rounded-lg p-4">
            <p class="text-sm text-primary-600 dark:text-primary-400">Seharusnya (Expected)</p>
            <p class="text-xl font-mono font-bold text-primary-700 dark:text-primary-300" id="summary-expected">Rp 0</p>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Modal Akhir (Rp)</label>
          <input type="number" id="closing-amount" class="input-field text-2xl font-mono" placeholder="0">
        </div>
        <div id="difference-alert" class="hidden rounded-lg p-3">
          <p class="text-sm font-medium" id="difference-text"></p>
        </div>
      </div>
      <div class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
        <button onclick="POSApp.closeModal('modal-close-session')" class="btn-secondary">Batal</button>
        <button onclick="POSApp.closeSession()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors"><i class="fas fa-lock mr-2"></i>Tutup Sesi</button>
      </div>
    </div>
  </div>
  
  <!-- ==================== PRODUCT LIST MODAL (Manager Only) ==================== -->
  <div id="modal-product-list" class="modal-overlay hidden">
    <div class="modal-content modal-large max-h-[90vh] overflow-hidden flex flex-col">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <h2 class="text-xl font-bold">Manajemen Produk</h2>
        <div class="flex gap-2">
          <button onclick="POSApp.showAddProductModal()" class="btn-primary"><i class="fas fa-plus mr-2"></i>Tambah Produk</button>
          <button onclick="POSApp.closeModal('modal-product-list')" class="w-8 h-8 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div class="p-4 border-b border-gray-200 dark:border-gray-700">
        <div class="flex gap-2">
          <div class="relative flex-1">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input type="text" id="product-list-search" class="input-field pl-10" placeholder="Cari produk..." oninput="POSApp.searchProductList(this.value)">
          </div>
          <select id="product-list-category" class="input-field w-40" onchange="POSApp.filterProductListByCategory(this.value)">
            <option value="">Semua Kategori</option>
          </select>
        </div>
      </div>
      <div class="flex-1 overflow-auto p-6">
        <table class="w-full">
          <thead class="bg-gray-50 dark:bg-gray-700/50 sticky top-0">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Produk</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">SKU/Barcode</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Harga</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Stok</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Aksi</th>
            </tr>
          </thead>
          <tbody id="product-list-table" class="divide-y divide-gray-200 dark:divide-gray-700">
            <!-- Dynamically populated -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ==================== PRODUCT MODAL (Add/Edit) ==================== -->
  <div id="modal-product" class="modal-overlay hidden">
    <div class="modal-content max-w-3xl max-h-[90vh] overflow-auto">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <h2 class="text-xl font-bold" id="product-modal-title">Tambah Produk</h2>
        <button onclick="POSApp.closeModal('modal-product')" class="w-8 h-8 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-6 space-y-4">
        <input type="hidden" id="prod-id">
        <div class="grid grid-cols-2 gap-4">
          <div class="col-span-2">
            <label class="block text-sm font-medium mb-1">URL Foto Produk</label>
            <input type="url" id="prod-image" class="input-field" placeholder="https://example.com/image.jpg">
          </div>
          <div class="col-span-2">
            <label class="block text-sm font-medium mb-1">Nama Produk <span class="text-red-500">*</span></label>
            <input type="text" id="prod-name" class="input-field" placeholder="Nama produk">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">SKU</label>
            <input type="text" id="prod-sku" class="input-field" placeholder="SKU-001">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Barcode</label>
            <div class="flex gap-2">
              <input type="text" id="prod-barcode" class="input-field" placeholder="Scan atau ketik">
              <button onclick="POSApp.scanBarcodeForProduct()" class="px-3 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600"><i class="fas fa-barcode"></i></button>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Harga <span class="text-red-500">*</span></label>
            <input type="number" id="prod-price" class="input-field font-mono" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Harga Diskon</label>
            <input type="number" id="prod-discount-price" class="input-field font-mono" placeholder="0">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Kategori</label>
            <select id="prod-category" class="input-field"><option value="">Pilih Kategori</option></select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Hashtag</label>
            <input type="text" id="prod-hashtags" class="input-field" placeholder="Promo, BrandA (pisah dengan koma)">
          </div>
        </div>
        <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
          <div class="flex items-center gap-3 mb-3">
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="prod-stock-enabled" class="sr-only peer">
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
            </label>
            <span class="text-sm font-medium">Aktifkan Manajemen Stok</span>
          </div>
          <div id="stock-quantity-container" class="hidden">
            <label class="block text-sm font-medium mb-1">Jumlah Stok</label>
            <input type="number" id="prod-stock-qty" class="input-field font-mono" placeholder="0">
          </div>
        </div>
        <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
          <div class="flex items-center justify-between mb-3">
            <span class="text-sm font-medium">Varian Produk</span>
            <button onclick="POSApp.addVariantRow()" class="text-sm text-primary-600 hover:underline"><i class="fas fa-plus mr-1"></i>Tambah Varian</button>
          </div>
          <div id="variants-container" class="space-y-2"></div>
        </div>
        <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
          <div class="flex items-center justify-between mb-3">
            <span class="text-sm font-medium">Harga Grosir</span>
            <button onclick="POSApp.addWholesaleRow()" class="text-sm text-primary-600 hover:underline"><i class="fas fa-plus mr-1"></i>Tambah Harga Grosir</button>
          </div>
          <div id="wholesale-container" class="space-y-2"></div>
        </div>
      </div>
      <div class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
        <button onclick="POSApp.closeModal('modal-product')" class="btn-secondary">Batal</button>
        <button onclick="POSApp.saveProduct()" class="btn-primary"><i class="fas fa-save mr-2"></i>Simpan</button>
      </div>
    </div>
  </div>

  <!-- ==================== VARIANT SELECTION MODAL ==================== -->
  <div id="modal-variant" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <h2 class="text-xl font-bold">Pilih Varian</h2>
        <button onclick="POSApp.closeModal('modal-variant')" class="w-8 h-8 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-6">
        <div id="variant-product-info" class="mb-4 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
          <h3 class="font-medium" id="variant-product-name">Nama Produk</h3>
          <p class="text-sm text-gray-500" id="variant-product-base-price">Harga Dasar: Rp 0</p>
        </div>
        <div id="variant-options" class="space-y-2">
          <!-- Dynamically populated -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- ==================== CUSTOMER LIST MODAL (Manager Only) ==================== -->
  <div id="modal-customer-list" class="modal-overlay hidden">
    <div class="modal-content modal-large max-h-[90vh] overflow-hidden flex flex-col">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <h2 class="text-xl font-bold">Manajemen Pelanggan</h2>
        <div class="flex gap-2">
          <button onclick="POSApp.showAddCustomerModal()" class="btn-primary"><i class="fas fa-plus mr-2"></i>Tambah Pelanggan</button>
          <button onclick="POSApp.closeModal('modal-customer-list')" class="w-8 h-8 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div class="p-4 border-b border-gray-200 dark:border-gray-700">
        <div class="flex gap-2">
          <div class="relative flex-1">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input type="text" id="customer-list-search" class="input-field pl-10" placeholder="Cari pelanggan..." oninput="POSApp.searchCustomerList(this.value)">
          </div>
          <select id="customer-list-category" class="input-field w-40">
            <option value="">Semua Kategori</option>
            <option value="member">Member</option>
            <option value="vip">VIP</option>
          </select>
        </div>
      </div>
      <div class="flex-1 overflow-auto p-6">
        <table class="w-full">
          <thead class="bg-gray-50 dark:bg-gray-700/50 sticky top-0">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pelanggan</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kontak</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID/Kategori</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Transaksi</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Aksi</th>
            </tr>
          </thead>
          <tbody id="customer-list-table" class="divide-y divide-gray-200 dark:divide-gray-700">
            <!-- Dynamically populated -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- ==================== CUSTOMER MODAL (Add/Edit) ==================== -->
  <div id="modal-customer" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <h2 class="text-xl font-bold" id="customer-modal-title">Tambah Pelanggan</h2>
        <button onclick="POSApp.closeModal('modal-customer')" class="w-8 h-8 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-6 space-y-4">
        <input type="hidden" id="cust-id">
        <div>
          <label class="block text-sm font-medium mb-1">Nama <span class="text-red-500">*</span></label>
          <input type="text" id="cust-name" class="input-field" placeholder="Nama pelanggan">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">No. Telepon</label>
            <input type="tel" id="cust-phone" class="input-field" placeholder="08123456789">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Email</label>
            <input type="email" id="cust-email" class="input-field" placeholder="email@example.com">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Alamat</label>
          <textarea id="cust-address" class="input-field" rows="2" placeholder="Alamat lengkap"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">ID/KTP/IG/Nopol</label>
            <input type="text" id="cust-id-number" class="input-field" placeholder="Nomor identitas">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Tanggal Lahir</label>
            <input type="date" id="cust-birth" class="input-field">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Kategori</label>
            <select id="cust-category" class="input-field">
              <option value="">Pilih Kategori</option>
              <option value="member">Member</option>
              <option value="vip">VIP</option>
              <option value="regular">Regular</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Catatan</label>
          <textarea id="cust-notes" class="input-field" rows="2" placeholder="Catatan tentang pelanggan"></textarea>
        </div>
      </div>
      <div class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
        <button onclick="POSApp.closeModal('modal-customer')" class="btn-secondary">Batal</button>
        <button onclick="POSApp.saveCustomer()" class="btn-primary"><i class="fas fa-save mr-2"></i>Simpan</button>
      </div>
    </div>
  </div>
  
  <!-- ==================== STORE SETTINGS MODAL ==================== -->
  <div id="modal-store-settings" class="modal-overlay hidden">
    <div class="modal-content max-w-2xl max-h-[90vh] overflow-auto">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <h2 class="text-xl font-bold">Pengaturan Toko</h2>
        <button onclick="POSApp.closeModal('modal-store-settings')" class="w-8 h-8 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-6 space-y-6">
        <div class="space-y-4">
          <h3 class="font-semibold text-gray-700 dark:text-gray-300">Informasi Toko</h3>
          <div class="grid grid-cols-2 gap-4">
            <div class="col-span-2">
              <label class="block text-sm font-medium mb-1">Nama Toko</label>
              <input type="text" id="store-name" class="input-field" placeholder="Nama toko">
            </div>
            <div class="col-span-2">
              <label class="block text-sm font-medium mb-1">Alamat</label>
              <textarea id="store-address" class="input-field" rows="2" placeholder="Alamat toko"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Telepon</label>
              <input type="tel" id="store-phone" class="input-field" placeholder="Nomor telepon">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Logo URL</label>
              <input type="url" id="store-logo" class="input-field" placeholder="https://example.com/logo.png">
            </div>
          </div>
        </div>
        <div class="border-t border-gray-200 dark:border-gray-700 pt-4 space-y-4">
          <h3 class="font-semibold text-gray-700 dark:text-gray-300">Pajak</h3>
          <div class="flex items-center gap-3">
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="tax-enabled" class="sr-only peer" onchange="POSApp.toggleTaxSettings()">
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
            </label>
            <span class="text-sm font-medium">Aktifkan Pajak</span>
          </div>
          <div id="tax-rate-container" class="hidden">
            <label class="block text-sm font-medium mb-1">Rate Pajak (%)</label>
            <input type="number" id="tax-rate" class="input-field font-mono" placeholder="10" min="0" max="100" onchange="POSApp.updateTaxRate()">
          </div>
        </div>
        <div class="border-t border-gray-200 dark:border-gray-700 pt-4 space-y-4">
          <h3 class="font-semibold text-gray-700 dark:text-gray-300">Tampilan di Panel Kasir</h3>
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <span class="text-sm">Tampilkan ID Pelanggan</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="show-cust-id" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
              </label>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm">Tampilkan Kategori Pelanggan</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="show-cust-category" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
              </label>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm">Tampilkan Catatan Pelanggan</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="show-cust-notes" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
              </label>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm">Aktifkan Transaksi Bertahap (Bayar Nanti)</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="enable-pending" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
              </label>
            </div>
          </div>
        </div>
        <div class="border-t border-gray-200 dark:border-gray-700 pt-4 space-y-4">
          <h3 class="font-semibold text-gray-700 dark:text-gray-300">Footer Nota</h3>
          <textarea id="receipt-footer" class="input-field" rows="3" placeholder="Terima kasih telah berbelanja&#10;Follow Instagram: @tokoanda"></textarea>
        </div>
      </div>
      <div class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
        <button onclick="POSApp.closeModal('modal-store-settings')" class="btn-secondary">Batal</button>
        <button onclick="POSApp.saveStoreSettings()" class="btn-primary"><i class="fas fa-save mr-2"></i>Simpan</button>
      </div>
    </div>
  </div>
  
  <!-- ==================== AI ANALYSIS MODAL ==================== -->
  <div id="modal-ai-analysis" class="modal-overlay hidden">
    <div class="modal-content max-w-3xl">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <h2 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-robot text-primary-600"></i>Analisa Transaksi AI</h2>
        <button onclick="POSApp.closeModal('modal-ai-analysis')" class="w-8 h-8 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-6 space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2">Dari Tanggal</label>
            <input type="date" id="ai-date-from" class="input-field">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Sampai Tanggal</label>
            <input type="date" id="ai-date-to" class="input-field">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2">Kasir (Opsional)</label>
            <select id="ai-cashier" class="input-field">
              <option value="">Semua Kasir</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Pelanggan (Opsional)</label>
            <select id="ai-customer" class="input-field">
              <option value="">Semua Pelanggan</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Prompt Kustom (Opsional)</label>
          <textarea id="ai-prompt" class="input-field" rows="3" placeholder="Kosongkan untuk analisa default. Contoh: 'Analisa produk yang paling laris dan berikan rekomendasi promo'"></textarea>
        </div>
        <div class="flex gap-2">
          <button onclick="POSApp.runAIAnalysis()" class="btn-primary flex-1"><i class="fas fa-play mr-2"></i>Jalankan Analisa</button>
        </div>
        <div id="ai-loading" class="hidden text-center py-8">
          <div class="spinner mx-auto mb-4"></div>
          <p class="text-gray-500">Sedang menganalisa data transaksi...</p>
        </div>
        <div id="ai-result" class="hidden space-y-4">
          <div class="bg-primary-50 dark:bg-primary-900/20 rounded-lg p-4">
            <h4 class="font-semibold text-primary-700 dark:text-primary-300 mb-2">Ringkasan</h4>
            <p id="ai-summary" class="text-sm text-gray-700 dark:text-gray-300"></p>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
              <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Rekomendasi</h4>
              <ul id="ai-recommendations" class="text-sm text-gray-600 dark:text-gray-400 space-y-1"></ul>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
              <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Tren</h4>
              <p id="ai-trends" class="text-sm text-gray-600 dark:text-gray-400"></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== TRANSACTION DETAIL MODAL ==================== -->
  <div id="modal-transaction-detail" class="modal-overlay hidden">
    <div class="modal-content max-w-2xl">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <h2 class="text-xl font-bold">Detail Transaksi</h2>
        <button onclick="POSApp.closeModal('modal-transaction-detail')" class="w-8 h-8 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center"><i class="fas fa-times"></i></button>
      </div>
      <div id="transaction-detail-content" class="p-6 space-y-4">
        <!-- Dynamically populated -->
      </div>
      <div class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
        <button onclick="POSApp.closeModal('modal-transaction-detail')" class="btn-secondary">Tutup</button>
        <button onclick="POSApp.printCurrentTransaction()" class="btn-primary"><i class="fas fa-print mr-2"></i>Cetak Struk</button>
      </div>
    </div>
  </div>
  
  <!-- ==================== MAIN APP LAYOUT ==================== -->
  <div id="main-app" class="hidden h-screen flex">
    
    <!-- ==================== PANEL KIRI ==================== -->
    <aside id="panel-left" class="panel-transition bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col" style="width: 320px;">
      <div class="h-14 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between px-3">
        <span class="font-semibold panel-label">Transaksi</span>
        <button onclick="POSApp.toggleLeftPanel()" class="w-8 h-8 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center">
          <i id="left-toggle-icon" class="fas fa-chevron-left text-gray-500"></i>
        </button>
      </div>
      <div class="flex border-b border-gray-200 dark:border-gray-700">
        <button onclick="POSApp.switchLeftTab('pending')" id="tab-pending" class="tab-btn active flex-1 py-2 text-xs"><i class="fas fa-clock mr-1"></i><span class="panel-label">Berjalan</span></button>
        <button onclick="POSApp.switchLeftTab('history')" id="tab-history" class="tab-btn flex-1 py-2 text-xs"><i class="fas fa-history mr-1"></i><span class="panel-label">History</span></button>
        <button onclick="POSApp.switchLeftTab('customer')" id="tab-customer-history" class="tab-btn flex-1 py-2 text-xs"><i class="fas fa-user mr-1"></i><span class="panel-label">Pelanggan</span></button>
      </div>
      <div class="flex-1 overflow-auto p-3">
        <!-- Pending Transactions -->
        <div id="content-pending" class="space-y-2"></div>
        
        <!-- History -->
        <div id="content-history" class="hidden space-y-3">
          <div class="flex gap-2 mb-3">
            <input type="date" id="history-date-from" class="input-field text-xs py-1" onchange="POSApp.filterHistory()">
            <input type="date" id="history-date-to" class="input-field text-xs py-1" onchange="POSApp.filterHistory()">
          </div>
          <select id="history-cashier" class="input-field text-xs py-1 mb-3" onchange="POSApp.filterHistory()">
            <option value="">Semua Kasir</option>
          </select>
          <div id="history-list" class="space-y-2"></div>
        </div>
        
        <!-- Customer Detail Panel -->
        <div id="content-customer-history" class="hidden">
          <div id="customer-detail-panel" class="hidden">
            <div class="customer-info-card rounded-lg p-4 mb-4">
              <div class="flex items-center gap-3 mb-3">
                <div class="w-12 h-12 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center">
                  <i class="fas fa-user text-primary-600 dark:text-primary-400 text-xl"></i>
                </div>
                <div>
                  <h3 class="font-bold" id="detail-cust-name">-</h3>
                  <p class="text-sm text-gray-500" id="detail-cust-phone">-</p>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-2 text-sm">
                <div id="detail-cust-id-row" class="hidden">
                  <span class="text-gray-500">ID:</span>
                  <span id="detail-cust-id" class="font-medium ml-1">-</span>
                </div>
                <div id="detail-cust-category-row" class="hidden">
                  <span class="text-gray-500">Kategori:</span>
                  <span id="detail-cust-category" class="font-medium ml-1">-</span>
                </div>
              </div>
              <div id="detail-cust-notes-row" class="hidden mt-2 p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded text-sm">
                <span class="text-yellow-700 dark:text-yellow-300"><i class="fas fa-sticky-note mr-1"></i><span id="detail-cust-notes">-</span></span>
              </div>
              <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700 flex justify-between text-sm">
                <span class="text-gray-500">Total Transaksi</span>
                <span id="detail-cust-transactions" class="font-bold">0</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Total Belanja</span>
                <span id="detail-cust-spent" class="font-bold text-primary-600">Rp 0</span>
              </div>
            </div>
            <h4 class="font-semibold text-sm mb-2 text-gray-600 dark:text-gray-400">Riwayat Transaksi</h4>
            <div id="customer-history-list" class="space-y-2"></div>
          </div>
          <div id="customer-empty-state" class="text-center py-8">
            <i class="fas fa-user-circle text-4xl text-gray-300 mb-2"></i>
            <p class="text-sm text-gray-500">Pilih pelanggan di panel kanan untuk melihat detail</p>
          </div>
        </div>
      </div>
    </aside>
    
    <!-- ==================== PANEL TENGAH ==================== -->
    <main id="panel-center" class="flex-1 flex flex-col bg-gray-50 dark:bg-gray-900 panel-transition">
      <header class="h-14 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between px-4">
        <div class="flex items-center gap-2 flex-1 max-w-md">
          <div class="relative flex-1">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input type="text" id="product-search" class="input-field pl-10" placeholder="Cari produk/SKU..." oninput="POSApp.searchProducts(this.value)">
          </div>
          <button onclick="POSApp.scanBarcode()" class="w-10 h-10 rounded-lg bg-primary-600 hover:bg-primary-700 text-white flex items-center justify-center" title="Scan Barcode"><i class="fas fa-barcode"></i></button>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="POSApp.showAIAnalysis()" id="btn-ai-analysis" class="hidden-feature px-3 py-2 rounded-lg bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 hover:bg-purple-200 dark:hover:bg-purple-900/50 text-sm font-medium transition-colors"><i class="fas fa-robot mr-2"></i>Analisa AI</button>
          <div class="relative">
            <button onclick="POSApp.toggleSettingsMenu()" class="w-10 h-10 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center"><i class="fas fa-cog text-gray-600 dark:text-gray-400"></i></button>
            <div id="settings-menu" class="hidden absolute right-0 top-full mt-2 w-48 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 z-50">
              <button onclick="POSApp.openProductManager()" id="menu-products" class="hidden-feature w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm"><i class="fas fa-box mr-2"></i>Produk</button>
              <button onclick="POSApp.openCustomerManager()" id="menu-customers" class="hidden-feature w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm"><i class="fas fa-users mr-2"></i>Pelanggan</button>
              <button onclick="POSApp.openStoreSettings()" id="menu-store" class="hidden-feature w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm"><i class="fas fa-store mr-2"></i>Toko</button>
              <div class="border-t border-gray-200 dark:border-gray-700"></div>
              <button onclick="POSApp.showCloseSessionModal()" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm text-red-600"><i class="fas fa-door-closed mr-2"></i>Tutup Kasir</button>
            </div>
          </div>
        </div>
      </header>
      <div class="h-12 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex items-center px-4 gap-3">
        <select id="filter-category" class="input-field text-sm py-1 w-40" onchange="POSApp.filterByCategory(this.value)"><option value="">Semua Kategori</option></select>
        <select id="filter-hashtag" class="input-field text-sm py-1 w-40" onchange="POSApp.filterByHashtag(this.value)"><option value="">Semua Hashtag</option></select>
        <div class="flex-1"></div>
        <button onclick="POSApp.toggleProductView()" class="w-8 h-8 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center" title="Toggle View"><i id="view-toggle-icon" class="fas fa-th-large text-gray-600 dark:text-gray-400"></i></button>
      </div>
      <div class="flex-1 overflow-auto p-4">
        <div id="products-container" class="grid-products"></div>
      </div>
    </main>
    
    <!-- ==================== PANEL KANAN ==================== -->
    <aside id="panel-right" class="w-96 bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 flex flex-col panel-transition">
      <div class="p-4 border-b border-gray-200 dark:border-gray-700 space-y-3">
        <div class="flex gap-2">
          <div class="relative flex-1">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
            <input type="text" id="customer-search" class="input-field pl-9 text-sm" placeholder="Cari pelanggan/nama/4 digit terakhir..." oninput="POSApp.searchCustomers(this.value)">
          </div>
          <button onclick="POSApp.quickAddCustomer()" class="w-9 h-9 rounded-lg bg-primary-600 hover:bg-primary-700 text-white flex items-center justify-center" title="Tambah Pelanggan"><i class="fas fa-plus text-sm"></i></button>
        </div>
        
        <!-- Selected Customer Info -->
        <div id="selected-customer" class="hidden">
          <div class="flex items-center justify-between">
            <div class="flex-1 min-w-0">
              <p class="font-medium text-sm truncate" id="cart-customer-name">-</p>
              <p class="text-xs text-gray-500" id="cart-customer-phone">-</p>
            </div>
            <button onclick="POSApp.clearCustomer()" class="text-gray-400 hover:text-red-500 ml-2"><i class="fas fa-times"></i></button>
          </div>
          <!-- Customer Extra Info (ID, Category, Notes) -->
          <div id="customer-extra-info" class="mt-2 flex flex-wrap gap-1">
            <span id="cart-customer-id" class="hidden text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-2 py-0.5 rounded"></span>
            <span id="cart-customer-category" class="hidden text-xs bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 px-2 py-0.5 rounded"></span>
            <span id="cart-customer-notes" class="hidden text-xs bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 px-2 py-0.5 rounded truncate max-w-full"></span>
          </div>
        </div>
        
        <!-- Queue Number Display -->
        <div id="queue-display" class="queue-number hidden">
          <div class="text-sm font-normal text-gray-600 dark:text-gray-400 mb-1">Nomor Antrian</div>
          <div id="current-queue-number">001</div>
        </div>
        
        <div class="flex gap-2">
          <select id="table-queue-type" class="input-field text-sm py-1 flex-1" onchange="POSApp.onTableQueueChange(this.value)">
            <option value="none">Tanpa Meja/Antrian</option>
            <option value="table">Meja</option>
            <option value="queue">Antrian</option>
          </select>
          <input type="text" id="table-number" class="hidden input-field text-sm py-1 w-20" placeholder="No.">
          <button id="queue-btn" onclick="POSApp.generateQueueNumber()" class="hidden w-9 h-9 rounded-lg bg-primary-600 hover:bg-primary-700 text-white flex items-center justify-center"><i class="fas fa-plus text-sm"></i></button>
        </div>
      </div>
      <div class="flex-1 overflow-auto p-4">
        <div id="cart-items" class="space-y-3">
          <div class="text-center text-gray-500 py-8">
            <i class="fas fa-shopping-cart text-4xl mb-2 opacity-30"></i>
            <p class="text-sm">Keranjang kosong</p>
            <p class="text-xs">Klik produk untuk menambahkan</p>
          </div>
        </div>
      </div>
      <div class="border-t border-gray-200 dark:border-gray-700 p-4 space-y-2 bg-gray-50 dark:bg-gray-800/50">
        <div class="flex justify-between text-sm">
          <span class="text-gray-600 dark:text-gray-400">Subtotal</span>
          <span class="font-mono" id="cart-subtotal">Rp 0</span>
        </div>
        <div id="cart-tax-row" class="flex justify-between text-sm hidden">
          <span class="text-gray-600 dark:text-gray-400">Pajak (<span id="tax-rate-display">0</span>%)</span>
          <span class="font-mono" id="cart-tax">Rp 0</span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-gray-600 dark:text-gray-400 text-sm" contenteditable="true" placeholder="Penyesuaian" id="adjustment-label">Penyesuaian</span>
          <div class="flex items-center gap-1">
            <span class="text-gray-400">Rp</span>
            <span class="font-mono min-w-[80px] text-right" contenteditable="true" placeholder="0" id="adjustment-amount" oninput="POSApp.onAdjustmentChange()">0</span>
          </div>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-gray-600 dark:text-gray-400 text-sm">Catatan</span>
          <span class="text-xs text-gray-400 flex-1 text-right mr-2" contenteditable="true" placeholder="Note" id="cart-notes">Note</span>
        </div>
        <div class="border-t border-gray-200 dark:border-gray-700 pt-2">
          <div class="flex justify-between text-lg font-bold">
            <span>TOTAL</span>
            <span class="font-mono text-primary-600 dark:text-primary-400" id="cart-total">Rp 0</span>
          </div>
        </div>
        <div id="pending-options" class="hidden pt-2">
          <div class="flex gap-2">
            <button onclick="POSApp.setPaymentMode('pending')" id="btn-pay-later" class="flex-1 py-2 rounded-lg border-2 border-yellow-500 text-yellow-600 hover:bg-yellow-50 dark:hover:bg-yellow-900/20 text-sm font-medium transition-colors">Bayar Nanti</button>
            <button onclick="POSApp.setPaymentMode('now')" id="btn-pay-now" class="flex-1 py-2 rounded-lg bg-primary-600 text-white hover:bg-primary-700 text-sm font-medium transition-colors">Bayar Sekarang</button>
            <button onclick="POSApp.setPaymentMode('complete')" id="btn-complete" class="flex-1 py-2 rounded-lg border-2 border-green-500 text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 text-sm font-medium transition-colors">Selesai</button>
          </div>
        </div>
        <div id="payment-section" class="pt-2 space-y-2">
          <select id="payment-method" class="input-field text-sm py-2" onchange="POSApp.onPaymentMethodChange(this.value)">
            <option value="cash">Cash (Tunai)</option>
            <option value="qris">QRIS</option>
            <option value="card">Kartu Debit/Kredit</option>
            <option value="transfer">Transfer Bank</option>
          </select>
          <div id="cash-details" class="space-y-2">
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-600 dark:text-gray-400">Dibayar</span>
              <div class="flex items-center gap-1">
                <span class="text-gray-400">Rp</span>
                <input type="number" id="payment-amount" class="w-24 text-right font-mono bg-transparent border-b border-gray-300 dark:border-gray-600 focus:border-primary-500 outline-none" placeholder="0" oninput="POSApp.calculateChange()">
              </div>
            </div>
            <div class="flex items-center justify-between text-green-600">
              <span class="text-sm font-medium">Kembalian</span>
              <span class="font-mono font-bold" id="change-amount">Rp 0</span>
            </div>
          </div>
        </div>
        <div class="flex gap-2 pt-3">
          <button onclick="POSApp.resetCart()" class="px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 font-medium transition-colors"><i class="fas fa-redo"></i></button>
          <button onclick="POSApp.processTransaction()" id="btn-process" class="flex-1 py-3 rounded-lg bg-primary-600 hover:bg-primary-700 text-white font-medium transition-colors flex items-center justify-center gap-2"><i class="fas fa-print"></i><span id="btn-process-text">Proses & Print</span></button>
        </div>
      </div>
    </aside>
  </div>
  
  <!-- ==================== JAVASCRIPT ==================== -->
  <script>
    // Audio context for beep sound
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    function playBeep() {
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.1);
    }

    class POSKasirApp {
      constructor() {
        this.state = {
          user: null, role: null, isManager: false, theme: 'light',
          session: null, cart: [], selectedCustomer: null,
          products: [], customers: [], categories: [], hashtags: [],
          pendingTransactions: [], transactions: [], settings: null,
          paymentMode: 'now', leftPanelCollapsed: false, productViewMode: 'card',
          editingTransactionId: null, currentQueueNumber: 0,
          currentTransactionDetail: null
        };
        this.init();
      }
      
      async init() {
        console.log('[POS Kasir] Initializing...');
        await this.getUserInfo();
        this.applyRoleUI();
        this.initThemeListener();
        await this.loadData();
        await this.checkSession();
        this.setupEventListeners();
        console.log('[POS Kasir] Initialized');
      }
      
      setupEventListeners() {
        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
          if (!e.target.closest('#settings-menu') && !e.target.closest('[onclick="POSApp.toggleSettingsMenu()"]')) {
            document.getElementById('settings-menu')?.classList.add('hidden');
          }
        });

        // Stock toggle
        document.getElementById('prod-stock-enabled')?.addEventListener('change', (e) => {
          document.getElementById('stock-quantity-container').classList.toggle('hidden', !e.target.checked);
        });

        // Tax toggle
        document.getElementById('tax-enabled')?.addEventListener('change', (e) => {
          document.getElementById('tax-rate-container').classList.toggle('hidden', !e.target.checked);
        });

        // Closing amount input
        document.getElementById('closing-amount')?.addEventListener('input', (e) => {
          const closing = parseFloat(e.target.value) || 0;
          const expectedText = document.getElementById('summary-expected').textContent;
          const expected = parseFloat(expectedText.replace(/[^0-9]/g, '')) || 0;
          const diff = closing - expected;
          const alertEl = document.getElementById('difference-alert');
          const textEl = document.getElementById('difference-text');
          alertEl.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'dark:bg-green-900/30', 'dark:text-green-200', 'dark:bg-red-900/30', 'dark:text-red-200');
          if (diff === 0) {
            alertEl.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-900/30', 'dark:text-green-200');
            textEl.textContent = ' Sesuai dengan expected';
          } else if (diff > 0) {
            alertEl.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-900/30', 'dark:text-green-200');
            textEl.textContent = `+${this.formatMoney(diff)} (Lebih)`;
          } else {
            alertEl.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900/30', 'dark:text-red-200');
            textEl.textContent = `${this.formatMoney(diff)} (Kurang)`;
          }
        });
      }
      
      async getUserInfo() {
        if (window.parent !== window && window.parent.TemenBoss) {
          try { this.state.user = window.parent.TemenBoss.getUser(); } catch (e) {}
        }
        if (!this.state.user) {
          this.state.user = { id: 'user-001', name: 'Kasir Demo', email: 'kasir@demo.com', role: 'manager_kasir' };
        }
        this.state.role = this.state.user.role;
        this.state.isManager = this.state.role === 'manager_kasir' || this.state.role === 'superadmin';
        console.log('[POS Kasir] User:', this.state.user.name, 'Role:', this.state.role);
      }
      
      applyRoleUI() {
        document.querySelectorAll('.hidden-feature').forEach(el => {
          if (this.state.isManager) el.classList.remove('hidden-feature');
        });
        if (!this.state.isManager) {
          ['menu-products', 'menu-customers', 'menu-store', 'btn-ai-analysis'].forEach(id => {
            document.getElementById(id)?.classList.add('hidden');
          });
        }
      }
      
      initThemeListener() {
        window.addEventListener('message', (event) => {
          if (event.data.type === 'THEME_CHANGE') this.applyTheme(event.data.theme);
        });
        if (window.parent !== window) window.parent.postMessage({ type: 'REQUEST_THEME' }, '*');
      }
      
      applyTheme(theme) {
        this.state.theme = theme;
        const html = document.documentElement;
        theme === 'dark' ? html.classList.add('dark') : html.classList.remove('dark');
      }
      
      async checkSession() {
        const sessions = await this.getFromDB('pos_sessions', { status: 'open' });
        if (sessions.length === 0) {
          document.getElementById('modal-open-session').classList.remove('hidden');
          document.getElementById('main-app').classList.add('hidden');
        } else {
          this.state.session = sessions[0];
          document.getElementById('modal-open-session').classList.add('hidden');
          document.getElementById('main-app').classList.remove('hidden');
        }
      }
      
      async openSession() {
        const amount = parseFloat(document.getElementById('opening-amount').value) || 0;
        if (amount < 0) { alert('Modal awal tidak valid'); return; }
        const session = {
          id: 'session-' + Date.now(), cashier_id: this.state.user.id, cashier_name: this.state.user.name,
          opening_amount: amount, total_transactions: 0, total_sales: 0,
          opened_at: new Date().toISOString(), status: 'open'
        };
        await this.saveToDB('pos_sessions', session);
        this.state.session = session;
        document.getElementById('modal-open-session').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        this.showToast('Sesi kasir dimulai', 'success');
      }
      
      showCloseSessionModal() {
        if (!this.state.session) return;
        const session = this.state.session;
        const expectedAmount = session.opening_amount + session.total_sales;
        document.getElementById('summary-opening').textContent = this.formatMoney(session.opening_amount);
        document.getElementById('summary-sales').textContent = this.formatMoney(session.total_sales);
        document.getElementById('summary-transactions').textContent = session.total_transactions;
        document.getElementById('summary-expected').textContent = this.formatMoney(expectedAmount);
        document.getElementById('modal-close-session').classList.remove('hidden');
      }
      
      async closeSession() {
        const closingAmount = parseFloat(document.getElementById('closing-amount').value) || 0;
        const expectedAmount = this.state.session.opening_amount + this.state.session.total_sales;
        const sessionUpdate = {
          closing_amount: closingAmount, expected_amount: expectedAmount,
          difference: closingAmount - expectedAmount,
          total_transactions: this.state.session.total_transactions,
          total_sales: this.state.session.total_sales,
          closed_at: new Date().toISOString(), status: 'closed'
        };
        await this.updateInDB('pos_sessions', this.state.session.id, sessionUpdate);
        this.showToast('Sesi kasir ditutup', 'success');
        this.logout();
      }
      
      logout() {
        if (window.parent !== window && window.parent.TemenBoss) {
          window.parent.TemenBoss.navigate('dashboard');
        } else location.reload();
      }
      
      async loadData() {
        const settings = await this.getFromDB('pos_settings');
        this.state.settings = settings[0] || this.getDefaultSettings();
        this.state.products = await this.getFromDB('pos_products', { is_active: true });
        if (this.state.products.length === 0) this.state.products = this.getDummyProducts();
        this.state.customers = await this.getFromDB('pos_customers');
        if (this.state.customers.length === 0) this.state.customers = this.getDummyCustomers();
        this.state.categories = await this.getFromDB('pos_categories');
        this.state.hashtags = await this.getFromDB('pos_hashtags');
        this.state.pendingTransactions = await this.getFromDB('pos_transactions', { status: 'pending' });
        this.state.transactions = await this.getFromDB('pos_transactions', {}, 50);
        this.renderProducts(); this.renderCategories(); this.renderHashtags();
        this.renderPendingTransactions(); this.renderHistory(); 
        this.applySettings(); this.populateAIFilters();
      }
      
      getDefaultSettings() {
        return { 
          id: 'main', store_name: 'Toko Saya', store_address: '', store_phone: '', store_logo: '',
          tax_enabled: false, tax_rate: 10, show_customer_id: false, show_customer_category: false,
          show_customer_notes: false, enable_pending_transactions: false, 
          receipt_footer: 'Terima kasih telah berbelanja'
        };
      }
      
      getDummyProducts() {
        return [
          { id: 'p1', name: 'Nasi Goreng Spesial', sku: 'NGS-001', barcode: '1234567890123', price: 25000, discount_price: null, category_id: 'food', hashtags: ['Best Seller'], image_url: '', stock_enabled: true, stock_quantity: 50, variants: [], wholesale_prices: [] },
          { id: 'p2', name: 'Mie Ayam Bakso', sku: 'MAB-001', barcode: '1234567890124', price: 20000, discount_price: 18000, category_id: 'food', hashtags: ['Promo'], image_url: '', stock_enabled: true, stock_quantity: 30, variants: [], wholesale_prices: [] },
          { id: 'p3', name: 'Es Teh Manis', sku: 'ETM-001', barcode: '1234567890125', price: 5000, discount_price: null, category_id: 'drink', hashtags: [], image_url: '', stock_enabled: true, stock_quantity: 100, variants: [], wholesale_prices: [] },
          { id: 'p4', name: 'Kopi Hitam', sku: 'KPH-001', barcode: '1234567890126', price: 8000, discount_price: null, category_id: 'drink', hashtags: ['Best Seller'], image_url: '', stock_enabled: true, stock_quantity: 0, variants: [], wholesale_prices: [] },
          { id: 'p5', name: 'Ayam Goreng', sku: 'AYG-001', barcode: '1234567890127', price: 15000, discount_price: null, category_id: 'food', hashtags: [], image_url: '', stock_enabled: false, stock_quantity: 0, variants: [{ name: 'Paha', price: 15000 }, { name: 'Dada', price: 17000 }, { name: 'Sayap', price: 13000 }], wholesale_prices: [{ min_qty: 10, price: 13000 }] },
          { id: 'p6', name: 'Sate Ayam', sku: 'STA-001', barcode: '1234567890128', price: 20000, discount_price: null, category_id: 'food', hashtags: [], image_url: '', stock_enabled: true, stock_quantity: 25, variants: [], wholesale_prices: [] },
          { id: 'p7', name: 'Gado-Gado', sku: 'GDG-001', barcode: '1234567890129', price: 18000, discount_price: null, category_id: 'food', hashtags: ['Sehat'], image_url: '', stock_enabled: true, stock_quantity: 15, variants: [], wholesale_prices: [] },
          { id: 'p8', name: 'Jus Alpukat', sku: 'JAL-001', barcode: '1234567890130', price: 12000, discount_price: 10000, category_id: 'drink', hashtags: ['Promo', 'Sehat'], image_url: '', stock_enabled: true, stock_quantity: 40, variants: [{ name: 'Tanpa Gula', price: 12000 }, { name: 'Extra Susu', price: 15000 }], wholesale_prices: [] }
        ];
      }
      
      getDummyCustomers() {
        return [
          { id: 'c1', name: 'Budi Santoso', phone: '081234567890', email: '', address: '', id_number: 'KTP-123456', birth_date: '', category_id: 'member', notes: 'Langganan setiap pagi', total_transactions: 15, total_spent: 450000 },
          { id: 'c2', name: 'Ani Wijaya', phone: '081234567891', email: '', address: '', id_number: '', birth_date: '', category_id: 'vip', notes: 'Pelanggan VIP', total_transactions: 8, total_spent: 200000 },
          { id: 'c3', name: 'Dedi Kurniawan', phone: '081234567892', email: '', address: '', id_number: 'IG:@dedik', birth_date: '', category_id: 'regular', notes: 'Influencer', total_transactions: 3, total_spent: 75000 }
        ];
      }
      
      async getFromDB(store, query = {}, limit = null) {
        const key = 'pos_' + store;
        const data = JSON.parse(localStorage.getItem(key) || '[]');
        let filtered = data;
        if (Object.keys(query).length > 0) filtered = data.filter(item => Object.entries(query).every(([k, v]) => item[k] === v));
        if (limit) filtered = filtered.slice(0, limit);
        return filtered;
      }
      
      async saveToDB(store, data) {
        const key = 'pos_' + store;
        const existing = JSON.parse(localStorage.getItem(key) || '[]');
        existing.push(data);
        localStorage.setItem(key, JSON.stringify(existing));
        return data;
      }
      
      async updateInDB(store, id, updates) {
        const key = 'pos_' + store;
        const existing = JSON.parse(localStorage.getItem(key) || '[]');
        const index = existing.findIndex(item => item.id === id);
        if (index >= 0) {
          existing[index] = { ...existing[index], ...updates };
          localStorage.setItem(key, JSON.stringify(existing));
        }
        return existing[index];
      }
      
      async deleteFromDB(store, id) {
        const key = 'pos_' + store;
        const existing = JSON.parse(localStorage.getItem(key) || '[]');
        const filtered = existing.filter(item => item.id !== id);
        localStorage.setItem(key, JSON.stringify(filtered));
      }

      // ==================== PRODUCT MANAGEMENT ====================
      
      openProductManager() {
        if (!this.state.isManager) { this.showToast('Akses ditolak', 'error'); return; }
        this.renderProductList();
        document.getElementById('modal-product-list').classList.remove('hidden');
      }

      renderProductList() {
        const tbody = document.getElementById('product-list-table');
        const categorySelect = document.getElementById('product-list-category');
        
        // Populate categories
        if (categorySelect.options.length <= 1) {
          const categories = [{ id: 'food', name: 'Makanan' }, { id: 'drink', name: 'Minuman' }, { id: 'snack', name: 'Snack' }];
          categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.name;
            categorySelect.appendChild(option);
          });
        }

        tbody.innerHTML = this.state.products.map(product => {
          const isSoldOut = product.stock_enabled && product.stock_quantity <= 0;
          const hasDiscount = product.discount_price && product.discount_price < product.price;
          const priceDisplay = hasDiscount 
            ? `<span class="line-through text-gray-400 text-xs">${this.formatMoney(product.price)}</span> <span class="text-red-600 font-bold">${this.formatMoney(product.discount_price)}</span>`
            : this.formatMoney(product.price);
          
          return `
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
              <td class="px-4 py-3">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                    ${product.image_url ? `<img src="${product.image_url}" class="w-full h-full object-cover rounded">` : '<i class="fas fa-box text-gray-400"></i>'}
                  </div>
                  <div>
                    <div class="font-medium text-sm">${product.name}</div>
                    <div class="text-xs text-gray-500">${product.hashtags?.join(', ') || ''}</div>
                  </div>
                </div>
              </td>
              <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">
                <div>${product.sku || '-'}</div>
                <div class="text-xs">${product.barcode || ''}</div>
              </td>
              <td class="px-4 py-3 text-right text-sm">${priceDisplay}</td>
              <td class="px-4 py-3 text-center text-sm">
                ${product.stock_enabled 
                  ? `<span class="${product.stock_quantity < 10 ? 'text-red-600 font-bold' : 'text-gray-600'}">${product.stock_quantity}</span>`
                  : '<span class="text-gray-400">-</span>'}
              </td>
              <td class="px-4 py-3 text-center">
                <button onclick="POSApp.editProduct('${product.id}')" class="text-blue-600 hover:text-blue-800 mr-2" title="Edit"><i class="fas fa-edit"></i></button>
                <button onclick="POSApp.deleteProduct('${product.id}')" class="text-red-600 hover:text-red-800" title="Hapus"><i class="fas fa-trash"></i></button>
              </td>
            </tr>
          `;
        }).join('');
      }

      searchProductList(query) {
        if (!query) { this.renderProductList(); return; }
        const filtered = this.state.products.filter(p => 
          p.name.toLowerCase().includes(query.toLowerCase()) || 
          p.sku?.toLowerCase().includes(query.toLowerCase())
        );
        const original = this.state.products;
        this.state.products = filtered;
        this.renderProductList();
        this.state.products = original;
      }

      filterProductListByCategory(categoryId) {
        if (!categoryId) { this.renderProductList(); return; }
        const filtered = this.state.products.filter(p => p.category_id === categoryId);
        const original = this.state.products;
        this.state.products = filtered;
        this.renderProductList();
        this.state.products = original;
      }

      showAddProductModal() {
        document.getElementById('product-modal-title').textContent = 'Tambah Produk';
        document.getElementById('prod-id').value = '';
        this.clearProductForm();
        this.populateProductCategories();
        document.getElementById('modal-product').classList.remove('hidden');
        document.getElementById('modal-product-list').classList.add('hidden');
      }

      editProduct(productId) {
        const product = this.state.products.find(p => p.id === productId);
        if (!product) return;

        document.getElementById('product-modal-title').textContent = 'Edit Produk';
        document.getElementById('prod-id').value = product.id;
        document.getElementById('prod-name').value = product.name;
        document.getElementById('prod-sku').value = product.sku || '';
        document.getElementById('prod-barcode').value = product.barcode || '';
        document.getElementById('prod-price').value = product.price;
        document.getElementById('prod-discount-price').value = product.discount_price || '';
        document.getElementById('prod-image').value = product.image_url || '';
        document.getElementById('prod-hashtags').value = product.hashtags?.join(', ') || '';
        document.getElementById('prod-stock-enabled').checked = product.stock_enabled;
        document.getElementById('prod-stock-qty').value = product.stock_quantity || 0;
        document.getElementById('stock-quantity-container').classList.toggle('hidden', !product.stock_enabled);

        this.populateProductCategories();
        document.getElementById('prod-category').value = product.category_id || '';

        // Variants
        const variantContainer = document.getElementById('variants-container');
        variantContainer.innerHTML = '';
        product.variants?.forEach(v => {
          const row = document.createElement('div');
          row.className = 'flex gap-2';
          row.innerHTML = `<input type="text" class="variant-name input-field text-sm flex-1" placeholder="Nama varian" value="${v.name}"><input type="number" class="variant-price input-field text-sm w-28 font-mono" placeholder="Harga" value="${v.price}"><button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>`;
          variantContainer.appendChild(row);
        });

        // Wholesale
        const wholesaleContainer = document.getElementById('wholesale-container');
        wholesaleContainer.innerHTML = '';
        product.wholesale_prices?.forEach(w => {
          const row = document.createElement('div');
          row.className = 'flex gap-2';
          row.innerHTML = `<input type="number" class="wholesale-min input-field text-sm w-28 font-mono" placeholder="Min. qty" value="${w.min_qty}"><input type="number" class="wholesale-price input-field text-sm w-28 font-mono" placeholder="Harga" value="${w.price}"><button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>`;
          wholesaleContainer.appendChild(row);
        });

        document.getElementById('modal-product').classList.remove('hidden');
        document.getElementById('modal-product-list').classList.add('hidden');
      }

      async deleteProduct(productId) {
        if (!confirm('Yakin ingin menghapus produk ini?')) return;
        await this.deleteFromDB('pos_products', productId);
        this.state.products = this.state.products.filter(p => p.id !== productId);
        this.renderProductList();
        this.renderProducts();
        this.showToast('Produk dihapus', 'success');
      }

      clearProductForm() {
        document.getElementById('prod-name').value = '';
        document.getElementById('prod-sku').value = '';
        document.getElementById('prod-barcode').value = '';
        document.getElementById('prod-price').value = '';
        document.getElementById('prod-discount-price').value = '';
        document.getElementById('prod-image').value = '';
        document.getElementById('prod-hashtags').value = '';
        document.getElementById('prod-stock-enabled').checked = false;
        document.getElementById('prod-stock-qty').value = '';
        document.getElementById('stock-quantity-container').classList.add('hidden');
        document.getElementById('variants-container').innerHTML = '';
        document.getElementById('wholesale-container').innerHTML = '';
      }

      populateProductCategories() {
        const select = document.getElementById('prod-category');
        select.innerHTML = '<option value="">Pilih Kategori</option>';
        const categories = [{ id: 'food', name: 'Makanan' }, { id: 'drink', name: 'Minuman' }, { id: 'snack', name: 'Snack' }];
        categories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat.id;
          option.textContent = cat.name;
          select.appendChild(option);
        });
      }
      
      addVariantRow() {
        const container = document.getElementById('variants-container');
        const row = document.createElement('div');
        row.className = 'flex gap-2';
        row.innerHTML = `<input type="text" class="variant-name input-field text-sm flex-1" placeholder="Nama varian"><input type="number" class="variant-price input-field text-sm w-28 font-mono" placeholder="Harga"><button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>`;
        container.appendChild(row);
      }
      
      addWholesaleRow() {
        const container = document.getElementById('wholesale-container');
        const row = document.createElement('div');
        row.className = 'flex gap-2';
        row.innerHTML = `<input type="number" class="wholesale-min input-field text-sm w-28 font-mono" placeholder="Min. qty"><input type="number" class="wholesale-price input-field text-sm w-28 font-mono" placeholder="Harga"><button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>`;
        container.appendChild(row);
      }
      
      async saveProduct() {
        const id = document.getElementById('prod-id').value;
        const variants = [];
        document.querySelectorAll('#variants-container > div').forEach(row => {
          const name = row.querySelector('.variant-name').value;
          const price = parseFloat(row.querySelector('.variant-price').value);
          if (name && price) variants.push({ name, price });
        });
        
        const wholesale = [];
        document.querySelectorAll('#wholesale-container > div').forEach(row => {
          const minQty = parseInt(row.querySelector('.wholesale-min').value);
          const price = parseFloat(row.querySelector('.wholesale-price').value);
          if (minQty && price) wholesale.push({ min_qty: minQty, price });
        });
        
        const productData = {
          name: document.getElementById('prod-name').value,
          sku: document.getElementById('prod-sku').value,
          barcode: document.getElementById('prod-barcode').value,
          price: parseFloat(document.getElementById('prod-price').value) || 0,
          discount_price: parseFloat(document.getElementById('prod-discount-price').value) || null,
          category_id: document.getElementById('prod-category').value,
          hashtags: document.getElementById('prod-hashtags').value.split(',').map(h => h.trim()).filter(h => h),
          image_url: document.getElementById('prod-image').value,
          stock_enabled: document.getElementById('prod-stock-enabled').checked,
          stock_quantity: parseInt(document.getElementById('prod-stock-qty').value) || 0,
          variants: variants,
          wholesale_prices: wholesale,
          is_active: true,
          updated_at: new Date().toISOString()
        };

        if (!productData.name || !productData.price) {
          this.showToast('Nama dan harga wajib diisi', 'error');
          return;
        }

        if (id) {
          // Update existing
          productData.id = id;
          await this.updateInDB('pos_products', id, productData);
          const index = this.state.products.findIndex(p => p.id === id);
          if (index >= 0) this.state.products[index] = productData;
        } else {
          // Create new
          productData.id = 'prod-' + Date.now();
          productData.created_at = new Date().toISOString();
          await this.saveToDB('pos_products', productData);
          this.state.products.push(productData);
        }

        this.closeModal('modal-product');
        this.renderProductList();
        this.renderProducts();
        this.showToast(id ? 'Produk diperbarui' : 'Produk ditambahkan', 'success');
      }

      // ==================== CUSTOMER MANAGEMENT ====================

      openCustomerManager() {
        if (!this.state.isManager) { this.showToast('Akses ditolak', 'error'); return; }
        this.renderCustomerList();
        document.getElementById('modal-customer-list').classList.remove('hidden');
      }

      renderCustomerList() {
        const tbody = document.getElementById('customer-list-table');
        tbody.innerHTML = this.state.customers.map(customer => `
          <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
            <td class="px-4 py-3">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center">
                  <i class="fas fa-user text-primary-600 dark:text-primary-400"></i>
                </div>
                <div>
                  <div class="font-medium text-sm">${customer.name}</div>
                  <div class="text-xs text-gray-500">${customer.address || ''}</div>
                </div>
              </div>
            </td>
            <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">
              <div>${customer.phone || '-'}</div>
              <div class="text-xs">${customer.email || ''}</div>
            </td>
            <td class="px-4 py-3 text-sm">
              ${customer.id_number ? `<div class="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded inline-block mb-1">${customer.id_number}</div>` : ''}
              ${customer.category_id ? `<div class="text-xs bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 px-2 py-0.5 rounded inline-block">${customer.category_id}</div>` : ''}
            </td>
            <td class="px-4 py-3 text-center text-sm">
              <div class="font-medium">${customer.total_transactions}</div>
              <div class="text-xs text-gray-500">${this.formatMoney(customer.total_spent)}</div>
            </td>
            <td class="px-4 py-3 text-center">
              <button onclick="POSApp.editCustomer('${customer.id}')" class="text-blue-600 hover:text-blue-800 mr-2" title="Edit"><i class="fas fa-edit"></i></button>
              <button onclick="POSApp.deleteCustomer('${customer.id}')" class="text-red-600 hover:text-red-800" title="Hapus"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `).join('');
      }

      searchCustomerList(query) {
        if (!query) { this.renderCustomerList(); return; }
        const filtered = this.state.customers.filter(c => 
          c.name.toLowerCase().includes(query.toLowerCase()) || 
          c.phone?.includes(query)
        );
        const original = this.state.customers;
        this.state.customers = filtered;
        this.renderCustomerList();
        this.state.customers = original;
      }

      showAddCustomerModal() {
        document.getElementById('customer-modal-title').textContent = 'Tambah Pelanggan';
        document.getElementById('cust-id').value = '';
        this.clearCustomerForm();
        document.getElementById('modal-customer').classList.remove('hidden');
        document.getElementById('modal-customer-list')?.classList.add('hidden');
      }

      editCustomer(customerId) {
        const customer = this.state.customers.find(c => c.id === customerId);
        if (!customer) return;

        document.getElementById('customer-modal-title').textContent = 'Edit Pelanggan';
        document.getElementById('cust-id').value = customer.id;
        document.getElementById('cust-name').value = customer.name;
        document.getElementById('cust-phone').value = customer.phone || '';
        document.getElementById('cust-email').value = customer.email || '';
        document.getElementById('cust-address').value = customer.address || '';
        document.getElementById('cust-id-number').value = customer.id_number || '';
        document.getElementById('cust-birth').value = customer.birth_date || '';
        document.getElementById('cust-category').value = customer.category_id || '';
        document.getElementById('cust-notes').value = customer.notes || '';

        document.getElementById('modal-customer').classList.remove('hidden');
        document.getElementById('modal-customer-list')?.classList.add('hidden');
      }

      async deleteCustomer(customerId) {
        if (!confirm('Yakin ingin menghapus pelanggan ini?')) return;
        await this.deleteFromDB('pos_customers', customerId);
        this.state.customers = this.state.customers.filter(c => c.id !== customerId);
        this.renderCustomerList();
        this.showToast('Pelanggan dihapus', 'success');
      }

      clearCustomerForm() {
        document.getElementById('cust-name').value = '';
        document.getElementById('cust-phone').value = '';
        document.getElementById('cust-email').value = '';
        document.getElementById('cust-address').value = '';
        document.getElementById('cust-id-number').value = '';
        document.getElementById('cust-birth').value = '';
        document.getElementById('cust-category').value = '';
        document.getElementById('cust-notes').value = '';
      }
      
      async saveCustomer() {
        const id = document.getElementById('cust-id').value;
        const customerData = {
          name: document.getElementById('cust-name').value,
          phone: document.getElementById('cust-phone').value,
          email: document.getElementById('cust-email').value,
          address: document.getElementById('cust-address').value,
          id_number: document.getElementById('cust-id-number').value,
          birth_date: document.getElementById('cust-birth').value,
          category_id: document.getElementById('cust-category').value,
          notes: document.getElementById('cust-notes').value,
          updated_at: new Date().toISOString()
        };

        if (!customerData.name) {
          this.showToast('Nama wajib diisi', 'error');
          return;
        }

        if (id) {
          customerData.id = id;
          await this.updateInDB('pos_customers', id, customerData);
          const index = this.state.customers.findIndex(c => c.id === id);
          if (index >= 0) {
            customerData.total_transactions = this.state.customers[index].total_transactions;
            customerData.total_spent = this.state.customers[index].total_spent;
            this.state.customers[index] = customerData;
          }
        } else {
          customerData.id = 'cust-' + Date.now();
          customerData.total_transactions = 0;
          customerData.total_spent = 0;
          customerData.created_at = new Date().toISOString();
          await this.saveToDB('pos_customers', customerData);
          this.state.customers.push(customerData);
        }

        this.closeModal('modal-customer');
        this.renderCustomerList();
        this.showToast(id ? 'Pelanggan diperbarui' : 'Pelanggan ditambahkan', 'success');
      }

      // ==================== VARIANT SELECTION ====================

      showVariantModal(product) {
        document.getElementById('variant-product-name').textContent = product.name;
        document.getElementById('variant-product-base-price').textContent = `Harga Dasar: ${this.formatMoney(product.price)}`;
        
        const container = document.getElementById('variant-options');
        container.innerHTML = product.variants.map((variant, index) => `
          <button onclick="POSApp.selectVariant('${product.id}', ${index})" class="w-full p-4 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-primary-500 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-all flex items-center justify-between">
            <span class="font-medium">${variant.name}</span>
            <span class="font-bold text-primary-600">${this.formatMoney(variant.price)}</span>
          </button>
        `).join('');
        
        document.getElementById('modal-variant').classList.remove('hidden');
      }

      selectVariant(productId, variantIndex) {
        this.closeModal('modal-variant');
        this.addToCart(productId, variantIndex);
      }

      // ==================== RENDER METHODS ====================
      
      renderProducts() {
        const container = document.getElementById('products-container');
        const isListView = this.state.productViewMode === 'list';
        if (this.state.products.length === 0) {
          container.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500"><i class="fas fa-box-open text-4xl mb-2 opacity-30"></i><p>Tidak ada produk</p></div>';
          return;
        }
        container.innerHTML = this.state.products.map(product => {
          const isSoldOut = product.stock_enabled && product.stock_quantity <= 0;
          const hasDiscount = product.discount_price && product.discount_price < product.price;
          const hasVariants = product.variants && product.variants.length > 0;
          
          if (isListView) {
            return `<div class="product-card ${isSoldOut ? 'sold-out' : ''} bg-white dark:bg-gray-800 rounded-lg p-3 border border-gray-200 dark:border-gray-700 cursor-pointer flex items-center gap-3" onclick="${hasVariants ? `POSApp.showVariantModal(${JSON.stringify(product).replace(/"/g, '&quot;')})` : `POSApp.addToCart('${product.id}')`}">
              <div class="flex-1 min-w-0"><h4 class="font-medium text-sm truncate">${product.name}</h4>
                <div class="flex items-center gap-2 mt-1">${hasDiscount ? `<span class="text-xs text-gray-400 line-through">${this.formatMoney(product.price)}</span><span class="text-sm font-bold text-red-600">${this.formatMoney(product.discount_price)}</span>` : `<span class="text-sm font-bold text-primary-600">${this.formatMoney(product.price)}</span>`}${product.stock_enabled ? `<span class="text-xs ${product.stock_quantity < 10 ? 'text-red-500' : 'text-gray-500'}">Stok: ${product.stock_quantity}</span>` : ''}</div>
              </div>${hasVariants ? `<span class="variant-badge">${product.variants.length} varian</span>` : ''}${hasDiscount ? `<span class="discount-badge">-${Math.round((1 - product.discount_price/product.price) * 100)}%</span>` : ''}</div>`;
          }
          return `<div class="product-card ${isSoldOut ? 'sold-out' : ''} bg-white dark:bg-gray-800 rounded-xl overflow-hidden border border-gray-200 dark:border-gray-700 cursor-pointer" onclick="${hasVariants ? `POSApp.showVariantModal(${JSON.stringify(product).replace(/"/g, '&quot;')})` : `POSApp.addToCart('${product.id}')`}">
            <div class="aspect-square bg-gray-100 dark:bg-gray-700 flex items-center justify-center">${product.image_url ? `<img src="${product.image_url}" class="w-full h-full object-cover" alt="${product.name}">` : `<i class="fas fa-image text-4xl text-gray-300 dark:text-gray-600"></i>`}</div>
            <div class="p-3"><h4 class="font-medium text-sm line-clamp-2 mb-1">${product.name}</h4>
              <div class="flex items-center gap-2 flex-wrap">${hasDiscount ? `<span class="text-xs text-gray-400 line-through">${this.formatMoney(product.price)}</span><span class="text-sm font-bold text-red-600">${this.formatMoney(product.discount_price)}</span>` : `<span class="text-sm font-bold text-primary-600">${this.formatMoney(product.price)}</span>`}</div>
              ${product.hashtags?.length ? `<div class="flex gap-1 mt-2 flex-wrap">${product.hashtags.map(h => `<span class="text-xs bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded">#${h}</span>`).join('')}</div>` : ''}
              ${hasVariants ? `<div class="mt-2"><span class="variant-badge">${product.variants.length} varian</span></div>` : ''}
              ${isSoldOut ? `<div class="mt-2"><span class="text-xs bg-red-100 dark:bg-red-900/30 text-red-600 px-2 py-0.5 rounded">Habis</span></div>` : ''}
            </div></div>`;
        }).join('');
      }
      
      renderCategories() {
        const select = document.getElementById('filter-category');
        const productCategorySelect = document.getElementById('prod-category');
        const categories = [{ id: 'food', name: 'Makanan' }, { id: 'drink', name: 'Minuman' }, { id: 'snack', name: 'Snack' }];
        const options = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        if (select) select.innerHTML += options;
      }
      
      renderHashtags() {
        const select = document.getElementById('filter-hashtag');
        const hashtags = ['Best Seller', 'Promo', 'Sehat', 'Baru'];
        if (select) select.innerHTML += hashtags.map(h => `<option value="${h}">${h}</option>`).join('');
      }
      
      renderPendingTransactions() {
        const container = document.getElementById('content-pending');
        if (this.state.pendingTransactions.length === 0) {
          container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-clock text-3xl mb-2 opacity-30"></i><p class="text-sm">Tidak ada transaksi berjalan</p></div>';
          return;
        }
        container.innerHTML = this.state.pendingTransactions.map(t => `
          <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3 cursor-pointer hover:bg-yellow-100 dark:hover:bg-yellow-900/30 transition-colors" onclick="POSApp.continueTransaction('${t.id}')">
            <div class="flex items-center justify-between mb-1">
              <span class="font-medium text-sm">${t.invoice_number}</span>
              <span class="text-xs text-yellow-700 dark:text-yellow-300 bg-yellow-200 dark:bg-yellow-800 px-2 py-0.5 rounded">Pending</span>
            </div>
            <p class="text-xs text-gray-600 dark:text-gray-400">${t.customer_name || 'Tanpa Pelanggan'}</p>
            <div class="flex items-center justify-between mt-2">
              <span class="text-xs text-gray-500">${new Date(t.created_at).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}</span>
              <span class="font-mono font-medium text-sm">${this.formatMoney(t.total)}</span>
            </div>
            <div class="mt-2 flex gap-1">
              <button onclick="event.stopPropagation(); POSApp.continueTransaction('${t.id}')" class="flex-1 py-1 bg-primary-600 text-white text-xs rounded hover:bg-primary-700">Buka</button>
              ${t.payment_amount > 0 ? `<button onclick="event.stopPropagation(); POSApp.completeTransaction('${t.id}')" class="flex-1 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">Selesai</button>` : ''}
            </div>
          </div>`).join('');
      }
      
      renderHistory() {
        const container = document.getElementById('history-list');
        const transactions = this.filterHistoryData();
        
        if (transactions.length === 0) {
          container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-history text-3xl mb-2 opacity-30"></i><p class="text-sm">Belum ada transaksi</p></div>';
          return;
        }
        container.innerHTML = transactions.map(t => `
          <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-3">
            <div class="flex items-center justify-between mb-1">
              <span class="font-medium text-sm">${t.invoice_number}</span>
              <span class="text-xs ${t.status === 'completed' ? 'status-completed' : t.status === 'pending' ? 'status-pending' : 'status-cancelled'} px-2 py-0.5 rounded">${t.status === 'completed' ? 'Selesai' : t.status === 'pending' ? 'Pending' : 'Batal'}</span>
            </div>
            <p class="text-xs text-gray-500">${t.customer_name || 'Tanpa Pelanggan'}</p>
            <div class="flex items-center justify-between mt-2">
              <span class="text-xs text-gray-400">${new Date(t.created_at).toLocaleString('id-ID')}</span>
              <span class="font-mono font-medium">${this.formatMoney(t.total)}</span>
            </div>
            <div class="flex gap-2 mt-2">
              <button onclick="POSApp.viewTransactionDetail('${t.id}')" class="text-xs text-blue-600 hover:underline"><i class="fas fa-eye mr-1"></i>Detail</button>
              <button onclick="POSApp.reprintReceipt('${t.id}')" class="text-xs text-primary-600 hover:underline"><i class="fas fa-print mr-1"></i>Print Ulang</button>
            </div>
          </div>`).join('');
      }

      filterHistoryData() {
        const fromDate = document.getElementById('history-date-from')?.value;
        const toDate = document.getElementById('history-date-to')?.value;
        const cashierFilter = document.getElementById('history-cashier')?.value;
        
        let filtered = [...this.state.transactions];
        
        if (fromDate) {
          const from = new Date(fromDate);
          filtered = filtered.filter(t => new Date(t.created_at) >= from);
        }
        if (toDate) {
          const to = new Date(toDate);
          to.setDate(to.getDate() + 1);
          filtered = filtered.filter(t => new Date(t.created_at) < to);
        }
        if (cashierFilter) {
          filtered = filtered.filter(t => t.cashier_id === cashierFilter);
        }
        
        return filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      }

      filterHistory() {
        this.renderHistory();
      }
      
      applySettings() {
        const settings = this.state.settings;
        // Tax settings
        if (settings.tax_enabled) {
          document.getElementById('cart-tax-row').classList.remove('hidden');
          document.getElementById('tax-rate-display').textContent = settings.tax_rate;
        } else {
          document.getElementById('cart-tax-row').classList.add('hidden');
        }
        
        // Pending transactions
        if (settings.enable_pending_transactions) {
          document.getElementById('pending-options').classList.remove('hidden');
        } else {
          document.getElementById('pending-options').classList.add('hidden');
        }

        // Update cart summary to apply tax
        this.updateCartSummary();
      }

      toggleTaxSettings() {
        const enabled = document.getElementById('tax-enabled').checked;
        document.getElementById('tax-rate-container').classList.toggle('hidden', !enabled);
      }

      updateTaxRate() {
        const rate = parseFloat(document.getElementById('tax-rate').value) || 0;
        document.getElementById('tax-rate-display').textContent = rate;
      }
      
      // ==================== NAVIGATION & UI ====================
      
      toggleLeftPanel() {
        const panel = document.getElementById('panel-left');
        const icon = document.getElementById('left-toggle-icon');
        const labels = panel.querySelectorAll('.panel-label');
        this.state.leftPanelCollapsed = !this.state.leftPanelCollapsed;
        if (this.state.leftPanelCollapsed) {
          panel.style.width = '60px'; icon.className = 'fas fa-chevron-right text-gray-500'; labels.forEach(l => l.classList.add('hidden'));
        } else {
          panel.style.width = '320px'; icon.className = 'fas fa-chevron-left text-gray-500'; labels.forEach(l => l.classList.remove('hidden'));
        }
      }
      
      switchLeftTab(tab) {
        document.querySelectorAll('#panel-left .tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        document.getElementById('content-pending').classList.add('hidden');
        document.getElementById('content-history').classList.add('hidden');
        document.getElementById('content-customer-history').classList.add('hidden');
        document.getElementById(`content-${tab}`).classList.remove('hidden');
      }
      
      searchProducts(query) {
        if (!query) { this.renderProducts(); return; }
        const filtered = this.state.products.filter(p => p.name.toLowerCase().includes(query.toLowerCase()) || p.sku?.toLowerCase().includes(query.toLowerCase()) || p.barcode?.includes(query));
        const original = this.state.products;
        this.state.products = filtered; this.renderProducts(); this.state.products = original;
      }
      
      filterByCategory(categoryId) {
        if (!categoryId) { this.renderProducts(); return; }
        const filtered = this.state.products.filter(p => p.category_id === categoryId);
        const original = this.state.products;
        this.state.products = filtered; this.renderProducts(); this.state.products = original;
      }
      
      filterByHashtag(hashtag) {
        if (!hashtag) { this.renderProducts(); return; }
        const filtered = this.state.products.filter(p => p.hashtags?.includes(hashtag));
        const original = this.state.products;
        this.state.products = filtered; this.renderProducts(); this.state.products = original;
      }
      
      toggleProductView() {
        this.state.productViewMode = this.state.productViewMode === 'card' ? 'list' : 'card';
        document.getElementById('view-toggle-icon').className = this.state.productViewMode === 'card' ? 'fas fa-th-large' : 'fas fa-list';
        document.getElementById('products-container').classList.toggle('list-view', this.state.productViewMode === 'list');
        this.renderProducts();
      }
      
      // ==================== CART OPERATIONS ====================
      
      addToCart(productId, variantIndex = null) {
        // Play beep sound
        playBeep();
        
        const product = this.state.products.find(p => p.id === productId);
        if (!product) return;
        if (product.stock_enabled && product.stock_quantity <= 0) { this.showToast('Produk habis', 'error'); return; }
        
        const variant = variantIndex !== null ? product.variants[variantIndex] : null;
        const price = variant ? variant.price : (product.discount_price || product.price);
        const name = variant ? `${product.name} (${variant.name})` : product.name;
        const existingItem = this.state.cart.find(item => item.product_id === productId && item.variant_index === variantIndex);
        
        if (existingItem) { 
          existingItem.quantity++; 
          existingItem.subtotal = existingItem.quantity * existingItem.price; 
        } else { 
          this.state.cart.push({ 
            id: 'cart-' + Date.now(), 
            product_id: productId, 
            variant_index: variantIndex, 
            name: name, 
            price: price, 
            original_price: product.price, 
            quantity: 1, 
            subtotal: price 
          }); 
        }
        this.renderCart(); 
        this.showToast('Produk ditambahkan', 'success');
      }
      
      updateCartItem(cartItemId, delta) {
        const item = this.state.cart.find(i => i.id === cartItemId);
        if (!item) return;
        item.quantity += delta;
        if (item.quantity <= 0) this.state.cart = this.state.cart.filter(i => i.id !== cartItemId);
        else item.subtotal = item.quantity * item.price;
        this.renderCart();
      }
      
      setCartQuantity(cartItemId, quantity) {
        const item = this.state.cart.find(i => i.id === cartItemId);
        if (!item) return;
        quantity = parseInt(quantity) || 1;
        if (quantity <= 0) this.state.cart = this.state.cart.filter(i => i.id !== cartItemId);
        else { item.quantity = quantity; item.subtotal = item.quantity * item.price; }
        this.renderCart();
      }
      
      removeCartItem(cartItemId) {
        this.state.cart = this.state.cart.filter(i => i.id !== cartItemId);
        this.renderCart();
      }
      
      renderCart() {
        const container = document.getElementById('cart-items');
        if (this.state.cart.length === 0) {
          container.innerHTML = '<div class="text-center text-gray-500 py-8"><i class="fas fa-shopping-cart text-4xl mb-2 opacity-30"></i><p class="text-sm">Keranjang kosong</p><p class="text-xs">Klik produk untuk menambahkan</p></div>';
          this.updateCartSummary(); 
          return;
        }
        container.innerHTML = this.state.cart.map(item => `
          <div class="cart-item bg-gray-50 dark:bg-gray-700/30 rounded-lg p-3">
            <div class="flex items-start justify-between mb-2">
              <div class="flex-1 min-w-0">
                <p class="font-medium text-sm truncate">${item.name}</p>
                <p class="text-xs text-gray-500">${item.original_price > item.price ? `<span class="line-through">${this.formatMoney(item.original_price)}</span><span class="text-red-600 ml-1">${this.formatMoney(item.price)}</span>` : this.formatMoney(item.price)}</p>
              </div>
              <button onclick="POSApp.removeCartItem('${item.id}')" class="text-gray-400 hover:text-red-500 ml-2"><i class="fas fa-trash-alt text-xs"></i></button>
            </div>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <button onclick="POSApp.updateCartItem('${item.id}', -1)" class="w-6 h-6 rounded bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 flex items-center justify-center"><i class="fas fa-minus text-xs"></i></button>
                <input type="number" value="${item.quantity}" class="w-12 text-center bg-transparent border-b border-gray-300 dark:border-gray-600 font-mono text-sm" onchange="POSApp.setCartQuantity('${item.id}', this.value)">
                <button onclick="POSApp.updateCartItem('${item.id}', 1)" class="w-6 h-6 rounded bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 flex items-center justify-center"><i class="fas fa-plus text-xs"></i></button>
              </div>
              <span class="font-mono font-medium text-sm">${this.formatMoney(item.subtotal)}</span>
            </div>
          </div>`).join('');
        this.updateCartSummary();
      }
      
      updateCartSummary() {
        const subtotal = this.state.cart.reduce((sum, item) => sum + item.subtotal, 0);
        const adjustment = parseFloat(document.getElementById('adjustment-amount').textContent) || 0;
        
        // Calculate tax based on settings
        let tax = 0;
        if (this.state.settings?.tax_enabled) {
          tax = subtotal * (this.state.settings.tax_rate / 100);
        }
        
        const total = subtotal + tax + adjustment;
        document.getElementById('cart-subtotal').textContent = this.formatMoney(subtotal);
        document.getElementById('cart-tax').textContent = this.formatMoney(tax);
        document.getElementById('cart-total').textContent = this.formatMoney(total);
        
        const paymentMethod = document.getElementById('payment-method').value;
        if (paymentMethod === 'cash') {
          const paymentAmount = parseFloat(document.getElementById('payment-amount').value) || 0;
          const change = paymentAmount - total;
          document.getElementById('change-amount').textContent = this.formatMoney(Math.max(0, change));
        }
      }
      
      onAdjustmentChange() { 
        this.updateCartSummary(); 
      }
      
      resetCart() {
        if (this.state.cart.length === 0) return;
        if (!confirm('Kosongkan keranjang?')) return;
        this.state.cart = []; 
        this.state.selectedCustomer = null; 
        this.state.editingTransactionId = null;
        document.getElementById('selected-customer').classList.add('hidden');
        document.getElementById('customer-search').value = '';
        document.getElementById('adjustment-amount').textContent = '0';
        document.getElementById('adjustment-label').textContent = 'Penyesuaian';
        document.getElementById('cart-notes').textContent = 'Note';
        document.getElementById('payment-amount').value = '';
        document.getElementById('change-amount').textContent = 'Rp 0';
        document.getElementById('table-queue-type').value = 'none';
        document.getElementById('table-number').classList.add('hidden');
        document.getElementById('queue-btn').classList.add('hidden');
        document.getElementById('queue-display').classList.add('hidden');
        document.getElementById('customer-extra-info').classList.add('hidden');
        this.renderCart();
      }
      
      // ==================== CUSTOMER OPERATIONS ====================
      
      searchCustomers(query) {
        if (!query || query.length < 2) return;
        const filtered = this.state.customers.filter(c => c.name.toLowerCase().includes(query.toLowerCase()) || c.phone?.endsWith(query));
        if (filtered.length > 0) this.selectCustomer(filtered[0].id);
      }
      
      selectCustomer(customerId) {
        const customer = this.state.customers.find(c => c.id === customerId);
        if (!customer) return;
        
        this.state.selectedCustomer = customer;
        document.getElementById('selected-customer').classList.remove('hidden');
        document.getElementById('cart-customer-name').textContent = customer.name;
        document.getElementById('cart-customer-phone').textContent = customer.phone || '-';
        
        // Show extra info based on settings
        const extraInfo = document.getElementById('customer-extra-info');
        const settings = this.state.settings;
        
        if (settings.show_customer_id && customer.id_number) {
          document.getElementById('cart-customer-id').textContent = `ID: ${customer.id_number}`;
          document.getElementById('cart-customer-id').classList.remove('hidden');
        } else {
          document.getElementById('cart-customer-id').classList.add('hidden');
        }
        
        if (settings.show_customer_category && customer.category_id) {
          document.getElementById('cart-customer-category').textContent = customer.category_id.toUpperCase();
          document.getElementById('cart-customer-category').classList.remove('hidden');
        } else {
          document.getElementById('cart-customer-category').classList.add('hidden');
        }
        
        if (settings.show_customer_notes && customer.notes) {
          document.getElementById('cart-customer-notes').textContent = customer.notes;
          document.getElementById('cart-customer-notes').classList.remove('hidden');
        } else {
          document.getElementById('cart-customer-notes').classList.add('hidden');
        }
        
        if (settings.show_customer_id || settings.show_customer_category || settings.show_customer_notes) {
          extraInfo.classList.remove('hidden');
        }
        
        // Show customer detail in left panel
        this.showCustomerDetail(customerId);
      }
      
      showCustomerDetail(customerId) {
        const customer = this.state.customers.find(c => c.id === customerId);
        if (!customer) return;
        
        document.getElementById('customer-empty-state').classList.add('hidden');
        document.getElementById('customer-detail-panel').classList.remove('hidden');
        
        document.getElementById('detail-cust-name').textContent = customer.name;
        document.getElementById('detail-cust-phone').textContent = customer.phone || '-';
        document.getElementById('detail-cust-transactions').textContent = customer.total_transactions;
        document.getElementById('detail-cust-spent').textContent = this.formatMoney(customer.total_spent);
        
        const settings = this.state.settings;
        
        if (settings.show_customer_id && customer.id_number) {
          document.getElementById('detail-cust-id').textContent = customer.id_number;
          document.getElementById('detail-cust-id-row').classList.remove('hidden');
        } else {
          document.getElementById('detail-cust-id-row').classList.add('hidden');
        }
        
        if (settings.show_customer_category && customer.category_id) {
          document.getElementById('detail-cust-category').textContent = customer.category_id.toUpperCase();
          document.getElementById('detail-cust-category-row').classList.remove('hidden');
        } else {
          document.getElementById('detail-cust-category-row').classList.add('hidden');
        }
        
        if (settings.show_customer_notes && customer.notes) {
          document.getElementById('detail-cust-notes').textContent = customer.notes;
          document.getElementById('detail-cust-notes-row').classList.remove('hidden');
        } else {
          document.getElementById('detail-cust-notes-row').classList.add('hidden');
        }
        
        // Render customer history
        const transactions = this.state.transactions.filter(t => t.customer_id === customerId);
        const container = document.getElementById('customer-history-list');
        
        if (transactions.length === 0) {
          container.innerHTML = '<p class="text-center text-gray-500 text-sm py-4">Belum ada riwayat transaksi</p>';
        } else {
          container.innerHTML = transactions.map(t => `
            <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-2 text-sm">
              <div class="flex items-center justify-between">
                <span class="font-medium">${t.invoice_number}</span>
                <span class="font-mono">${this.formatMoney(t.total)}</span>
              </div>
              <p class="text-xs text-gray-500">${new Date(t.created_at).toLocaleDateString('id-ID')}</p>
            </div>
          `).join('');
        }
        
        this.switchLeftTab('customer');
      }
      
      clearCustomer() {
        this.state.selectedCustomer = null;
        document.getElementById('selected-customer').classList.add('hidden');
        document.getElementById('customer-search').value = '';
        document.getElementById('customer-extra-info').classList.add('hidden');
        document.getElementById('customer-detail-panel').classList.add('hidden');
        document.getElementById('customer-empty-state').classList.remove('hidden');
      }
      
      quickAddCustomer() {
        this.showAddCustomerModal();
      }
      
      // ==================== QUEUE & TABLE ====================
      
      onTableQueueChange(value) {
        document.getElementById('table-number').classList.toggle('hidden', value !== 'table');
        document.getElementById('queue-btn').classList.toggle('hidden', value !== 'queue');
        document.getElementById('queue-display').classList.toggle('hidden', value !== 'queue');
        
        if (value === 'queue' && this.state.currentQueueNumber === 0) {
          this.generateQueueNumber();
        }
      }

      generateQueueNumber() {
        this.state.currentQueueNumber++;
        document.getElementById('current-queue-number').textContent = String(this.state.currentQueueNumber).padStart(3, '0');
        document.getElementById('queue-display').classList.remove('hidden');
      }
      
      // ==================== PAYMENT ====================
      
      setPaymentMode(mode) {
        this.state.paymentMode = mode;
        document.getElementById('btn-pay-later').className = mode === 'pending' ? 'flex-1 py-2 rounded-lg bg-yellow-500 text-white text-sm font-medium transition-colors' : 'flex-1 py-2 rounded-lg border-2 border-yellow-500 text-yellow-600 hover:bg-yellow-50 dark:hover:bg-yellow-900/20 text-sm font-medium transition-colors';
        document.getElementById('btn-pay-now').className = mode === 'now' ? 'flex-1 py-2 rounded-lg bg-primary-600 text-white hover:bg-primary-700 text-sm font-medium transition-colors' : 'flex-1 py-2 rounded-lg border-2 border-primary-600 text-primary-600 hover:bg-primary-50 dark:hover:bg-primary-900/20 text-sm font-medium transition-colors';
        document.getElementById('btn-complete').className = mode === 'complete' ? 'flex-1 py-2 rounded-lg bg-green-500 text-white text-sm font-medium transition-colors' : 'flex-1 py-2 rounded-lg border-2 border-green-500 text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 text-sm font-medium transition-colors';
        
        const paymentSection = document.getElementById('payment-section');
        if (mode === 'pending') { 
          paymentSection.classList.add('hidden'); 
          document.getElementById('btn-process-text').textContent = 'Simpan (Bayar Nanti)'; 
        } else if (mode === 'complete') { 
          paymentSection.classList.add('hidden'); 
          document.getElementById('btn-process-text').textContent = 'Selesaikan'; 
        } else { 
          paymentSection.classList.remove('hidden'); 
          document.getElementById('btn-process-text').textContent = 'Proses & Print'; 
        }
      }
      
      onPaymentMethodChange(method) { 
        document.getElementById('cash-details').classList.toggle('hidden', method !== 'cash'); 
      }
      
      calculateChange() {
        const total = this.getCartTotal();
        const payment = parseFloat(document.getElementById('payment-amount').value) || 0;
        const change = payment - total;
        document.getElementById('change-amount').textContent = this.formatMoney(Math.max(0, change));
      }
      
      getCartTotal() {
        const subtotal = this.state.cart.reduce((sum, item) => sum + item.subtotal, 0);
        const adjustment = parseFloat(document.getElementById('adjustment-amount').textContent) || 0;
        let tax = 0;
        if (this.state.settings?.tax_enabled) tax = subtotal * (this.state.settings.tax_rate / 100);
        return subtotal + tax + adjustment;
      }
      
      // ==================== TRANSACTION PROCESSING ====================
      
      async processTransaction() {
        if (this.state.cart.length === 0) { this.showToast('Keranjang kosong', 'error'); return; }
        
        const total = this.getCartTotal();
        const paymentMethod = document.getElementById('payment-method').value;
        const paymentAmount = parseFloat(document.getElementById('payment-amount').value) || 0;
        
        if (this.state.paymentMode === 'now' && paymentMethod === 'cash' && paymentAmount < total) { 
          this.showToast('Pembayaran kurang', 'error'); 
          return; 
        }
        
        const transaction = {
          id: this.state.editingTransactionId || 'trx-' + Date.now(), 
          invoice_number: this.generateInvoiceNumber(),
          customer_id: this.state.selectedCustomer?.id || null, 
          customer_name: this.state.selectedCustomer?.name || null,
          cashier_id: this.state.user.id, 
          cashier_name: this.state.user.name,
          table_number: document.getElementById('table-number').value || null, 
          queue_number: this.state.currentQueueNumber > 0 ? this.state.currentQueueNumber : null,
          items: this.state.cart.map(item => ({ 
            product_id: item.product_id, 
            product_name: item.name, 
            price: item.price, 
            quantity: item.quantity, 
            subtotal: item.subtotal 
          })),
          subtotal: this.state.cart.reduce((sum, item) => sum + item.subtotal, 0),
          tax_amount: this.state.settings?.tax_enabled ? this.state.cart.reduce((sum, item) => sum + item.subtotal, 0) * (this.state.settings.tax_rate / 100) : 0,
          tax_rate: this.state.settings?.tax_rate || 0, 
          adjustment_label: document.getElementById('adjustment-label').textContent,
          adjustment_amount: parseFloat(document.getElementById('adjustment-amount').textContent) || 0, 
          total: total,
          payment_method: this.state.paymentMode === 'pending' ? 'pending' : paymentMethod,
          payment_amount: this.state.paymentMode === 'now' ? paymentAmount : 0, 
          change_amount: this.state.paymentMode === 'now' && paymentMethod === 'cash' ? paymentAmount - total : 0,
          notes: document.getElementById('cart-notes').textContent !== 'Note' ? document.getElementById('cart-notes').textContent : '',
          status: this.state.paymentMode === 'pending' ? 'pending' : 'completed', 
          session_id: this.state.session.id,
          created_at: new Date().toISOString(), 
          completed_at: this.state.paymentMode !== 'pending' ? new Date().toISOString() : null
        };
        
        if (this.state.editingTransactionId) {
          await this.updateInDB('pos_transactions', transaction.id, transaction);
          // Remove from pending if it was pending
          this.state.pendingTransactions = this.state.pendingTransactions.filter(t => t.id !== transaction.id);
        } else {
          await this.saveToDB('pos_transactions', transaction);
        }
        
        if (transaction.status === 'completed') {
          this.state.session.total_transactions++;
          this.state.session.total_sales += transaction.total;
          await this.updateInDB('pos_sessions', this.state.session.id, { 
            total_transactions: this.state.session.total_transactions, 
            total_sales: this.state.session.total_sales 
          });
        } else {
          // Add to pending
          this.state.pendingTransactions.push(transaction);
        }
        
        if (this.state.selectedCustomer && transaction.status === 'completed') {
          const customer = this.state.selectedCustomer;
          customer.total_transactions++; 
          customer.total_spent += transaction.total;
          await this.updateInDB('pos_customers', customer.id, { 
            total_transactions: customer.total_transactions, 
            total_spent: customer.total_spent 
          });
        }
        
        if (this.state.paymentMode !== 'pending') await this.printReceipt(transaction);
        
        this.resetCart();
        await this.loadData();
        this.showToast(
          this.state.paymentMode === 'pending' ? 'Transaksi disimpan (Bayar Nanti)' : 
          this.state.paymentMode === 'complete' ? 'Transaksi selesai' : 'Transaksi berhasil', 
          'success'
        );
      }
      
      generateInvoiceNumber() {
        const date = new Date();
        const prefix = 'INV';
        const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
        return `${prefix}${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}-${random}`;
      }
      
      async continueTransaction(transactionId) {
        const transaction = this.state.pendingTransactions.find(t => t.id === transactionId);
        if (!transaction) return;
        
        this.state.editingTransactionId = transactionId;
        this.state.cart = transaction.items.map(item => ({ 
          id: 'cart-' + Math.random().toString(36).substr(2, 9), 
          product_id: item.product_id, 
          variant_index: null, 
          name: item.product_name, 
          price: item.price, 
          original_price: item.price, 
          quantity: item.quantity, 
          subtotal: item.subtotal 
        }));
        
        if (transaction.customer_id) this.selectCustomer(transaction.customer_id);
        document.getElementById('adjustment-amount').textContent = transaction.adjustment_amount || 0;
        document.getElementById('adjustment-label').textContent = transaction.adjustment_label || 'Penyesuaian';
        if (transaction.notes) document.getElementById('cart-notes').textContent = transaction.notes;
        
        // Restore queue/table info
        if (transaction.queue_number) {
          document.getElementById('table-queue-type').value = 'queue';
          this.state.currentQueueNumber = transaction.queue_number;
          document.getElementById('current-queue-number').textContent = String(transaction.queue_number).padStart(3, '0');
          document.getElementById('queue-display').classList.remove('hidden');
          document.getElementById('queue-btn').classList.remove('hidden');
        } else if (transaction.table_number) {
          document.getElementById('table-queue-type').value = 'table';
          document.getElementById('table-number').value = transaction.table_number;
          document.getElementById('table-number').classList.remove('hidden');
        }
        
        // If already paid, show complete button
        if (transaction.payment_amount > 0) {
          this.setPaymentMode('complete');
        } else {
          this.setPaymentMode('now');
        }
        
        this.renderCart(); 
        this.showToast('Melanjutkan transaksi', 'info');
      }

      async completeTransaction(transactionId) {
        const transaction = this.state.pendingTransactions.find(t => t.id === transactionId);
        if (!transaction) return;
        
        transaction.status = 'completed';
        transaction.completed_at = new Date().toISOString();
        
        await this.updateInDB('pos_transactions', transactionId, transaction);
        
        this.state.session.total_transactions++;
        this.state.session.total_sales += transaction.total;
        await this.updateInDB('pos_sessions', this.state.session.id, { 
          total_transactions: this.state.session.total_transactions, 
          total_sales: this.state.session.total_sales 
        });
        
        await this.printReceipt(transaction);
        await this.loadData();
        this.showToast('Transaksi diselesaikan', 'success');
      }
      
      // ==================== RECEIPT & PRINT ====================
      
      async printReceipt(transaction) {
        const receiptData = {
          store_name: this.state.settings?.store_name || 'Toko Saya', 
          store_address: this.state.settings?.store_address || '', 
          store_phone: this.state.settings?.store_phone || '',
          invoice_number: transaction.invoice_number, 
          date: new Date(transaction.created_at).toLocaleString('id-ID'), 
          cashier: transaction.cashier_name, 
          customer: transaction.customer_name || '-',
          items: transaction.items, 
          subtotal: transaction.subtotal, 
          tax: transaction.tax_amount, 
          adjustment: transaction.adjustment_amount, 
          total: transaction.total,
          payment_method: transaction.payment_method, 
          payment_amount: transaction.payment_amount, 
          change: transaction.change_amount, 
          footer: this.state.settings?.receipt_footer || 'Terima kasih'
        };
        
        if (window.parent !== window && window.parent.TemenBoss) {
          try { 
            await window.parent.TemenBoss.printStruk(receiptData); 
            this.showToast('Struk dicetak', 'success'); 
          } catch (e) { 
            console.error('Print error:', e); 
            this.showToast('Gagal mencetak struk', 'error'); 
          }
        } else { 
          console.log('[Print Receipt]', receiptData); 
          this.showToast('Print (simulasi - lihat console)', 'info'); 
        }
      }
      
      async reprintReceipt(transactionId) {
        const transaction = this.state.transactions.find(t => t.id === transactionId);
        if (!transaction) return;
        await this.printReceipt(transaction);
      }

      // ==================== TRANSACTION DETAIL ====================

      viewTransactionDetail(transactionId) {
        const transaction = this.state.transactions.find(t => t.id === transactionId);
        if (!transaction) return;
        
        this.state.currentTransactionDetail = transaction;
        
        const content = document.getElementById('transaction-detail-content');
        content.innerHTML = `
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
              <span class="text-gray-500">Invoice</span>
              <p class="font-medium">${transaction.invoice_number}</p>
            </div>
            <div>
              <span class="text-gray-500">Tanggal</span>
              <p class="font-medium">${new Date(transaction.created_at).toLocaleString('id-ID')}</p>
            </div>
            <div>
              <span class="text-gray-500">Kasir</span>
              <p class="font-medium">${transaction.cashier_name}</p>
            </div>
            <div>
              <span class="text-gray-500">Status</span>
              <p class="font-medium">
                <span class="px-2 py-0.5 rounded text-xs ${transaction.status === 'completed' ? 'status-completed' : transaction.status === 'pending' ? 'status-pending' : 'status-cancelled'}">
                  ${transaction.status === 'completed' ? 'Selesai' : transaction.status === 'pending' ? 'Pending' : 'Batal'}
                </span>
              </p>
            </div>
            ${transaction.customer_name ? `
            <div class="col-span-2">
              <span class="text-gray-500">Pelanggan</span>
              <p class="font-medium">${transaction.customer_name}</p>
            </div>
            ` : ''}
            ${transaction.table_number ? `
            <div>
              <span class="text-gray-500">Meja</span>
              <p class="font-medium">${transaction.table_number}</p>
            </div>
            ` : ''}
            ${transaction.queue_number ? `
            <div>
              <span class="text-gray-500">Antrian</span>
              <p class="font-medium">#${String(transaction.queue_number).padStart(3, '0')}</p>
            </div>
            ` : ''}
          </div>
          
          <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
            <h4 class="font-medium mb-3">Item</h4>
            <div class="space-y-2">
              ${transaction.items.map(item => `
                <div class="flex justify-between text-sm">
                  <div>
                    <span class="font-medium">${item.product_name}</span>
                    <span class="text-gray-500">x${item.quantity}</span>
                  </div>
                  <span class="font-mono">${this.formatMoney(item.subtotal)}</span>
                </div>
              `).join('')}
            </div>
          </div>
          
          <div class="border-t border-gray-200 dark:border-gray-700 pt-4 space-y-2">
            <div class="flex justify-between text-sm">
              <span class="text-gray-500">Subtotal</span>
              <span class="font-mono">${this.formatMoney(transaction.subtotal)}</span>
            </div>
            ${transaction.tax_amount > 0 ? `
            <div class="flex justify-between text-sm">
              <span class="text-gray-500">Pajak (${transaction.tax_rate}%)</span>
              <span class="font-mono">${this.formatMoney(transaction.tax_amount)}</span>
            </div>
            ` : ''}
            ${transaction.adjustment_amount !== 0 ? `
            <div class="flex justify-between text-sm">
              <span class="text-gray-500">${transaction.adjustment_label || 'Penyesuaian'}</span>
              <span class="font-mono">${this.formatMoney(transaction.adjustment_amount)}</span>
            </div>
            ` : ''}
            <div class="flex justify-between text-lg font-bold border-t border-gray-200 dark:border-gray-700 pt-2">
              <span>Total</span>
              <span class="font-mono text-primary-600">${this.formatMoney(transaction.total)}</span>
            </div>
          </div>
          
          ${transaction.status !== 'pending' ? `
          <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
            <h4 class="font-medium mb-2">Pembayaran</h4>
            <div class="space-y-1 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-500">Metode</span>
                <span class="font-medium uppercase">${transaction.payment_method}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-500">Dibayar</span>
                <span class="font-mono">${this.formatMoney(transaction.payment_amount)}</span>
              </div>
              ${transaction.change_amount > 0 ? `
              <div class="flex justify-between">
                <span class="text-gray-500">Kembalian</span>
                <span class="font-mono text-green-600">${this.formatMoney(transaction.change_amount)}</span>
              </div>
              ` : ''}
            </div>
          </div>
          ` : `
          <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
            <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3">
              <p class="text-sm text-yellow-800 dark:text-yellow-200">
                <i class="fas fa-clock mr-1"></i>Transaksi ini masih pending/belum dibayar
              </p>
            </div>
          </div>
          `}
          
          ${transaction.notes ? `
          <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
            <span class="text-gray-500 text-sm">Catatan</span>
            <p class="text-sm mt-1">${transaction.notes}</p>
          </div>
          ` : ''}
        `;
        
        document.getElementById('modal-transaction-detail').classList.remove('hidden');
      }

      printCurrentTransaction() {
        if (this.state.currentTransactionDetail) {
          this.printReceipt(this.state.currentTransactionDetail);
        }
      }
      
      // ==================== AI ANALYSIS ====================
      
      populateAIFilters() {
        // Populate cashier filter
        const cashierSelect = document.getElementById('ai-cashier');
        const cashiers = [...new Set(this.state.transactions.map(t => t.cashier_id))];
        cashiers.forEach(cashierId => {
          const transaction = this.state.transactions.find(t => t.cashier_id === cashierId);
          const option = document.createElement('option');
          option.value = cashierId;
          option.textContent = transaction.cashier_name;
          cashierSelect.appendChild(option);
        });

        // Populate customer filter
        const customerSelect = document.getElementById('ai-customer');
        this.state.customers.forEach(customer => {
          const option = document.createElement('option');
          option.value = customer.id;
          option.textContent = customer.name;
          customerSelect.appendChild(option);
        });

        // Set default date range (last 7 days)
        const today = new Date();
        const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        document.getElementById('ai-date-to').value = today.toISOString().split('T')[0];
        document.getElementById('ai-date-from').value = lastWeek.toISOString().split('T')[0];
      }

      showAIAnalysis() {
        if (!this.state.isManager) { this.showToast('Fitur ini hanya untuk Manager', 'error'); return; }
        document.getElementById('modal-ai-analysis').classList.remove('hidden');
        document.getElementById('ai-loading').classList.add('hidden');
        document.getElementById('ai-result').classList.add('hidden');
      }

      async runAIAnalysis() {
        const fromDate = document.getElementById('ai-date-from').value;
        const toDate = document.getElementById('ai-date-to').value;
        const cashierFilter = document.getElementById('ai-cashier').value;
        const customerFilter = document.getElementById('ai-customer').value;
        const customPrompt = document.getElementById('ai-prompt').value;

        document.getElementById('ai-loading').classList.remove('hidden');
        document.getElementById('ai-result').classList.add('hidden');

        // Filter transactions
        let filteredTransactions = this.state.transactions.filter(t => t.status === 'completed');
        
        if (fromDate) {
          const from = new Date(fromDate);
          filteredTransactions = filteredTransactions.filter(t => new Date(t.created_at) >= from);
        }
        if (toDate) {
          const to = new Date(toDate);
          to.setDate(to.getDate() + 1);
          filteredTransactions = filteredTransactions.filter(t => new Date(t.created_at) < to);
        }
        if (cashierFilter) {
          filteredTransactions = filteredTransactions.filter(t => t.cashier_id === cashierFilter);
        }
        if (customerFilter) {
          filteredTransactions = filteredTransactions.filter(t => t.customer_id === customerFilter);
        }

        const totalSales = filteredTransactions.reduce((sum, t) => sum + t.total, 0);
        const totalTransactions = filteredTransactions.length;
        const totalItems = filteredTransactions.reduce((sum, t) => sum + t.items.reduce((isum, i) => isum + i.quantity, 0), 0);
        const avgTransaction = totalTransactions > 0 ? totalSales / totalTransactions : 0;
        
        // Top products
        const productSales = {};
        filteredTransactions.forEach(t => {
          t.items.forEach(item => {
            if (!productSales[item.product_name]) productSales[item.product_name] = { qty: 0, revenue: 0 };
            productSales[item.product_name].qty += item.quantity;
            productSales[item.product_name].revenue += item.subtotal;
          });
        });
        const topProducts = Object.entries(productSales)
          .sort((a, b) => b[1].revenue - a[1].revenue)
          .slice(0, 5);

        let prompt;
        if (customPrompt.trim()) {
          prompt = customPrompt + `\n\nData transaksi:\n- Periode: ${fromDate || 'Semua'} sampai ${toDate || 'Sekarang'}\n- Total Transaksi: ${totalTransactions}\n- Total Penjualan: Rp ${totalSales.toLocaleString('id-ID')}\n- Rata-rata Transaksi: Rp ${avgTransaction.toLocaleString('id-ID')}\n- Produk Terlaris: ${topProducts.map(p => p[0]).join(', ')}`;
        } else {
          prompt = `Analisa data transaksi berikut:\n- Periode: ${fromDate || 'Semua'} sampai ${toDate || 'Sekarang'}\n- Total Transaksi: ${totalTransactions}\n- Total Penjualan: Rp ${totalSales.toLocaleString('id-ID')}\n- Total Item Terjual: ${totalItems}\n- Rata-rata Transaksi: Rp ${avgTransaction.toLocaleString('id-ID')}\n\nProduk Terlaris:\n${topProducts.map((p, i) => `${i+1}. ${p[0]}: ${p[1].qty} pcs (Rp ${p[1].revenue.toLocaleString('id-ID')})`).join('\n')}\n\nBerikan ringkasan analisis, rekomendasi untuk meningkatkan penjualan, dan tren yang terlihat. Jawab dalam Bahasa Indonesia.`;
        }

        try {
          let response;
          if (window.parent !== window && window.parent.TemenBoss) {
            response = await window.parent.TemenBoss.askAI(prompt, 'gemini');
          } else {
            await new Promise(r => setTimeout(r, 1500));
            response = { 
              response: `ANALISA TRANSAKSI\n\nBerdasarkan data transaksi periode ${fromDate || 'semua waktu'} sampai ${toDate || 'sekarang'}, terdapat ${totalTransactions} transaksi dengan total penjualan Rp ${totalSales.toLocaleString('id-ID')}.\n\nREKOMENDASI:\n- Tingkatkan stok untuk produk terlaris: ${topProducts.slice(0, 3).map(p => p[0]).join(', ')}\n- Berikan promo bundling untuk meningkatkan average transaction\n- Fokus marketing pada jam sibuk berdasarkan pola transaksi\n\nTREN:\nPenjualan menunjukkan performa yang ${totalSales > 1000000 ? 'baik' : 'perlu ditingkatkan'}. Rata-rata transaksi Rp ${avgTransaction.toLocaleString('id-ID')} menunjukkan ${avgTransaction > 50000 ? 'pelanggan cenderung membeli dalam jumlah besar' : 'potensi upselling yang bisa dikembangkan'}.` 
            };
          }
          
          // Parse response
          const lines = response.response.split('\n').filter(l => l.trim());
          const summary = lines.slice(0, 3).join(' ');
          const recommendations = lines.filter(l => l.includes('-') || l.match(/^\d\./) || l.toLowerCase().includes('rekomendasi'));
          const trends = lines.filter(l => l.toLowerCase().includes('tren') || l.toLowerCase().includes('kesimpulan')).join(' ') || 'Analisis tren berdasarkan data transaksi menunjukkan pola pembelian yang konsisten.';
          
          document.getElementById('ai-summary').textContent = summary;
          document.getElementById('ai-recommendations').innerHTML = recommendations.length > 0 
            ? recommendations.map(r => `<li>${r.replace(/^[-\d.\s]+/, '')}</li>`).join('') 
            : '<li>Tingkatkan variasi produk</li><li>Berikan diskon volume</li><li>Optimalkan layanan pelanggan</li>';
          document.getElementById('ai-trends').textContent = trends;
          
        } catch (error) {
          document.getElementById('ai-summary').textContent = 'Gagal menganalisa data. Silakan coba lagi.';
          document.getElementById('ai-recommendations').innerHTML = '<li>Cek koneksi internet</li><li>Pastikan API key AI tersedia</li>';
          document.getElementById('ai-trends').textContent = '-';
        }
        
        document.getElementById('ai-loading').classList.add('hidden');
        document.getElementById('ai-result').classList.remove('hidden');
      }
      
      // ==================== SETTINGS ====================
      
      openStoreSettings() {
        if (!this.state.isManager) { this.showToast('Akses ditolak', 'error'); return; }
        const settings = this.state.settings;
        document.getElementById('store-name').value = settings.store_name || '';
        document.getElementById('store-address').value = settings.store_address || '';
        document.getElementById('store-phone').value = settings.store_phone || '';
        document.getElementById('store-logo').value = settings.store_logo || '';
        document.getElementById('tax-enabled').checked = settings.tax_enabled || false;
        document.getElementById('tax-rate').value = settings.tax_rate || 10;
        document.getElementById('show-cust-id').checked = settings.show_customer_id || false;
        document.getElementById('show-cust-category').checked = settings.show_customer_category || false;
        document.getElementById('show-cust-notes').checked = settings.show_customer_notes || false;
        document.getElementById('enable-pending').checked = settings.enable_pending_transactions || false;
        document.getElementById('receipt-footer').value = settings.receipt_footer || '';
        document.getElementById('tax-rate-container').classList.toggle('hidden', !settings.tax_enabled);
        document.getElementById('modal-store-settings').classList.remove('hidden');
      }
      
      async saveStoreSettings() {
        const settings = { 
          ...this.state.settings,
          store_name: document.getElementById('store-name').value, 
          store_address: document.getElementById('store-address').value, 
          store_phone: document.getElementById('store-phone').value, 
          store_logo: document.getElementById('store-logo').value, 
          tax_enabled: document.getElementById('tax-enabled').checked, 
          tax_rate: parseFloat(document.getElementById('tax-rate').value) || 10, 
          show_customer_id: document.getElementById('show-cust-id').checked, 
          show_customer_category: document.getElementById('show-cust-category').checked,
          show_customer_notes: document.getElementById('show-cust-notes').checked, 
          enable_pending_transactions: document.getElementById('enable-pending').checked, 
          receipt_footer: document.getElementById('receipt-footer').value, 
          updated_at: new Date().toISOString() 
        };
        
        await this.updateInDB('pos_settings', 'main', settings);
        this.state.settings = settings;
        this.closeModal('modal-store-settings');
        this.applySettings();
        this.showToast('Pengaturan disimpan', 'success');
      }
      
      // ==================== UTILITIES ====================
      
      async scanBarcode() {
        if (window.parent !== window && window.parent.TemenBoss) {
          try {
            const result = await window.parent.TemenBoss.scanBarcode();
            if (result && result.barcode) { 
              document.getElementById('product-search').value = result.barcode; 
              this.searchProducts(result.barcode); 
            }
          } catch (e) { this.showToast('Scanner tidak tersedia', 'error'); }
        } else {
          const mockBarcode = '1234567890123';
          document.getElementById('product-search').value = mockBarcode;
          this.searchProducts(mockBarcode);
          this.showToast('Barcode: ' + mockBarcode, 'info');
        }
      }
      
      async scanBarcodeForProduct() {
        if (window.parent !== window && window.parent.TemenBoss) {
          try {
            const result = await window.parent.TemenBoss.scanBarcode();
            if (result && result.barcode) document.getElementById('prod-barcode').value = result.barcode;
          } catch (e) { this.showToast('Scanner tidak tersedia', 'error'); }
        } else {
          const mockBarcode = '1234567890' + Math.floor(Math.random() * 100);
          document.getElementById('prod-barcode').value = mockBarcode;
        }
      }
      
      toggleSettingsMenu() { document.getElementById('settings-menu').classList.toggle('hidden'); }
      closeModal(modalId) { 
        document.getElementById(modalId).classList.add('hidden');
        // Show list modals if they were open
        if (modalId === 'modal-product') document.getElementById('modal-product-list')?.classList.remove('hidden');
        if (modalId === 'modal-customer') document.getElementById('modal-customer-list')?.classList.remove('hidden');
      }
      
      formatMoney(amount) { return 'Rp ' + (amount || 0).toLocaleString('id-ID'); }
      
      showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'} mr-2"></i>${message}`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }
    }
    
    const POSApp = new POSKasirApp();
  </script>
</body>
</html>